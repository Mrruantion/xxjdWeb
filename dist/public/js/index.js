!function(e){var t={};function a(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=t,a.d=function(e,t,o){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},a.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=11)}({11:function(e,t){var a=[],o=[],n=0,i=$(".task-list-cont"),l=[],c=getSearch(),s="";window.tree_path=s;var r,d=$.cookie("tree_path"),p=0,u=$.cookie("contentId"),f=[],h=[],m="-type|name|id";function v(){d=$.cookie("tree_path");var e,t,k,y=tools.$(".header")[0],w=tools.$(".weiyun-content")[0],b=y.offsetHeight,x=tools.$(".content")[0],P=tools.$(".file-list")[0],T=(tools.$(".tree-menu")[0],tools.$(".path-nav")[0]),E=tools.$(".g-empty")[0];$.cookie("uid");function C(){var e=window.innerHeight||document.documentElement.clientHeight;w.style.height=e-b+"px",x&&(x.style.height=e-b-62+"px"),P&&(P.style.height=e-b-93+"px")}function O(){var e="";return[1,2,3,4,5,6,7,8,9].forEach(function(t){e+='<option value="'+t+'">'+t+"</option>"}),e}C(),window.onresize=C,$("#qnum").empty().append(O()),$("#lnum").empty().append(O()),$("#jnum").empty().append(O()),$("#cnum").empty().append(O());var I=[],D=["id","fid","u_path","did","name","saveExpireIn","createdAt","num","page","qnum","lnum","jnum","cnum","ce","bnum","pname","lname"];function j(e){var t=document.createElement("li");t.style.marginTop="10px",t.dataset=e;var a=' \n            <label class="ellipsis" title="'+e+'">'+e+'</label>\n            <input value="" class="form-control" style="width:50%"/>\n            <button class="btn btn-primary newBtn" style="">删除</button>\n        ';t.innerHTML=a,$("#newPropLi").append(t),console.log($(t)),$("button",t).on("click",function(t){console.log(e),I.splice(I.indexOf(e),1),$(t.target).parent().remove()})}$("#divDocPro").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"保存":function(){N?function(){if(console.log(L),!L.length)return void showTips("err","该档案下没有案卷可设置");for(var e=[],t={u_path:d,name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),did:$("#did").val(),num:$("#num").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}L.forEach(function(a){var n=Object.assign({},t,o);n.fid=a,e.push(n)}),confirm("批量设置属性会覆盖案卷原有属性，是否批量设置属性")&&local_api._delete("docProp",{fid:L.join("|")},$.cookie("appkey"),function(t){console.log(t),local_api._createBatch("docProp",{data:JSON.stringify({data:e})},$.cookie("appkey"),function(e){createOperate("批量设置案卷属性"),$("#divDocPro").dialog("option","title","属性"),$("#divDocPro").dialog("close")})});console.log(e)}():function(){if(createOperate("单个设置属性"),S){for(var t={name:$("#name").val(),fid:e,u_path:d,saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(t,o),console.log(t),local_api._create("docProp",t,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}else{for(var l={name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},c={fid:e},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(l,o),console.log(l),local_api._update("docProp",c,l,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}}()},"取消":function(){$("#divDocPro").dialog("close")}}}),$("#selectProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择自定义属性",buttons:{"确定":function(){$("#selectProp").dialog("close")}}}),$("#newCustomProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"添加新属性",buttons:{"确定":function(){var e;e=$("#newPropname").val(),local_api._createColumn("docProp",{name:e,size:50},"",function(t){createOperate("添加自定义属性"),t.err?showTips("err","添加属性失败"):(j(e),I.push(e),$("#someProp").append('<option value="'+e+'">'+e+"</option>"),$("#newCustomProp").dialog("close"))})},"取消":function(){$("#newCustomProp").dialog("close")}}}),$("#someProp").on("change",function(e){console.log(this.value),0!=this.value&&(-1==I.indexOf(this.value)?(I.push(this.value),j(this.value)):showTips("err","该属性已存在"))}),$("#newProp").click(function(){$("#newCustomProp").dialog("open")}),$("#addCustom").click(function(){$("#selectProp").dialog("open")});var N=!1,A=[],M=[],H=[],L=[];$("#someProo").on("click",function(){N=!0,A=[],M=[],H=[],L=[],console.log(ae()),ae().length?(ae().forEach(function(e){3!=$(".item",e).data().type&&(A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path),H.push($(".item .file-title",e).text()))}),console.log(A,M,H),local_api.getTableColumns("docProp",$.cookie("appkey"),function(e){e.err||(I=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),e.row.forEach(function(e){-1==D.indexOf(e.Field)&&$("#someProp").append('<option value="'+e.Field+'">'+e.Field+"</option>")})),local_api._list("document",{tree_path:M.join("|"),type:2},"","",1,-1,$.cookie("appkey"),function(e){$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0),$("#divDocPro").dialog("option","title","批量设置属性"),$("#divDocPro").dialog("open"),e.data.forEach(function(e){L.push(e.id)})})})):showTips("err","请选择文件！")});var q,S=!1;function z(){for(var e=ae(),t={tree_path:[],id:[]},a=0;a<e.length;a++)t.tree_path.push("^"+$(".item",e[a]).data().tree_path),t.id.push($(".item",e[a]).data().fileId);return t}function F(){createOperate("移动");var e=z().tree_path,t=z().id;console.log(assignFid,assignTreePath,assignU_path);var a=[];local_api._list("document",{tree_path:e.join("|")},"","",1,-1,$.cookie("appkey"),function(e){e.data.forEach(function(o){var n={};if(n[o.id]={},t.indexOf(o.id)>-1){var i=function(t,o){var n=dataControl.getChildById(e.data,t);n.length&&n.forEach(function(e){var n={};n[e.id]={},n[e.id].pid=t,n[e.id].oldtree_path=e.tree_path;var l=o+","+e.id;n[e.id].tree_path=l,n[e.id].olePath=g(e.tree_path),n[e.id].newPath=g(l),n[e.id].u_path=assignU_path,n[e.id].name=e.name,n[e.id].type=e.type,a.push(n),i(e.id,l)})};n[o.id].pid=assignFid;var l=o.tree_path.indexOf(o.id),c=o.tree_path.length,s=assignTreePath+","+o.tree_path.slice(l,c);n[o.id].oldtree_path=o.tree_path,n[o.id].tree_path=s,n[o.id].olePath=g(o.tree_path),n[o.id].newPath=g(s),n[o.id].u_path=assignU_path,n[o.id].name=o.name,n[o.id].type=o.type,a.push(n),i(o.id,s)}}),console.log(a);$("#divDocumentAssign").dialog("close"),function e(t,a){console.log(t[a]);var o=t[a];for(var n in o)if(3==o[n].type){var i={oldPath:o[n].olePath,newPath:o[n].newPath,name:o[n].name,type:2};local_api._rename(i,$.cookie("appkey"),function(i){if(0==i.status){var l={path:"/upload/"+o[n].newPath+i.name,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path,name:i.name},c={id:n};local_api._update("document",c,l,$.cookie("appkey"),function(o){a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),t[a]&&e(t,a),a==t.length&&X(p)})}else a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),t[a]&&e(t,a),a==t.length&&X(p)})}else{var l={path:"/upload/"+o[n].newPath,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path},c={id:n};local_api._update("document",c,l,$.cookie("appkey"),function(o){a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),a==t.length&&X(p),t[a]&&e(t,a)})}}(a,0)})}function B(e){local_api._list("document",{type:"0|1|2|4"},"","did|id",1,-1,$.cookie("appkey"),function(t){h=t.data,e&&e()})}function X(e){B(),local_api._list("document",{type:"0|1|2|4",u_path:$.cookie("tree_path")+"|^"+$.cookie("tree_path")+","},"","createdAt",1,-1,$.cookie("appkey"),function(a){0==a.status&&a.total&&(t=a.data,e=e||a.data[0].pid,u=c.fileId||u||a.data[0].id,s=s||a.data[0].tree_path,d=d||a.data[0].u_path,c.fileId&&local_api._get("document",{id:c.fileId},"",$.cookie("appkey"),function(e){e.data&&(s=e.data.tree_path,d=e.data.u_path)}),c.fileId=null,$(".file-list").empty(),$("#tree-menu").empty(),U(),P.innerHTML=createFilesHtml(t,u),$(document).on("click",".file-list .file-item",Y),function(e){var t=[];customers=e;for(var a=0;a<e.length;a++)t.push(e[a].name);for(var o={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(u=a.id,$.cookie("contentId",u),s=a.treePath,d=a.u_path,J(u))}}},n={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(assignFid=a.id,assignTreePath=a.treePath,assignU_path=a.u_path,assignPath=a.path)}}},i=[],l=[],a=0;a<e.length;a++)i.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:R[e[a].type],path:e[a].path}),l.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:R[e[a].type],path:e[a].path});if($.fn.zTree.init($("#tree-menu"),o,i),$.fn.zTree.init($("#documentTreeAssign"),n,l),u>=0){var c=$.fn.zTree.getZTreeObj("tree-menu"),r=c.getNodeByParam("id",u,null);r&&(s=r.treePath,d=r.u_path,c.selectNode(r))}}(t),T.innerHTML=createPathNavHtml(t,u),J(u),tools.addEvent(T,"click",Z))})}$("#divDocAudit").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档审核",buttons:{"确定":function(){!function(){createOperate("文档审核");var e={ispass:$("#divDocAudit input[name]:checked").val()},t={tree_path:M.join("|")};local_api._update("document",t,e,$.cookie("appkey"),function(e){console.log(e),showTips("ok","审核成功！"),$("#divDocAudit").dialog("close")})}()},"取消":function(){$("#divDocAudit").dialog("close")}}}),$("#passDoc").on("click",function(){L=[],M=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),$("#divDocAudit").dialog("open")):showTips("err","请选择文件！")}),$("#divDocLock").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档加锁",buttons:{"确定":function(){var e,t;e={islock:parseInt($("#divDocLock input[name]:checked").val())},t={tree_path:M.join("|")},local_api._update("document",t,e,$.cookie("appkey"),function(e){0==e.status?(showTips("ok","加锁成功！"),$("#divDocLock").dialog("close"),J(u)):showTips("err","加锁失败！")})},"取消":function(){$("#divDocLock").dialog("close")}}}),$("#lockDoc").on("click",function(){L=[],M=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),$("#divDocLock").dialog("open")):showTips("err","请选择文档！")}),$("#printCode").on("click",function(e){e.stopPropagation(),createOperate("打印二维码"),L=[],M=[],H=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),function(e){var t={tree_path:e.join("|"),type:2,did:">0"};local_api._list("document",t,"did,name","did",1,-1,$.cookie("appkey"),function(e){var t=e.data,a=$("#qrcodePrint")[0]||document.createElement("div");a.id="qrcodePrint";var o='<ul class="qrcodePrint">';t.forEach(function(e){o+='<li><img src="http://h5.bibibaba.cn/pay/wicare/wxpayv3/qrcode.php?data='+e.did+'"><span>'+e.did+"</span></li>"}),o+="</ul>",a.innerHTML=o,$("#qrcodePrint")[0]?($(a).empty(),$(a).append(o)):$("body").append(a);var n=window.document.body.innerHTML,i=$("#qrcodePrint").html();window.document.body.innerHTML=i,function(e){var t,a=!0;!function e(o){$(".qrcodePrint img").each(function(){if(console.log(this.height),0===this.height)return a=!1,!1});a?(clearTimeout(t),o()):(a=!0,t=setTimeout(function(){e(o)},500))}(function(){window.print(),window.document.body.innerHTML=e,v()})}(n)})}(M)):showTips("err","请选择文件！")}),$("#divDocumentAssign").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){F()},"取消":function(){$("#divDocumentAssign").dialog("close")}}}),$(".move").on("click",function(e){ae().length?(console.log(z()),$("#divDocumentAssign").dialog("option","title","移动"),$("#divDocumentAssign").dialog("open")):showTips("err","请选择需要移动的案卷或分类")}),X(p);var Y=function(t){if(console.log(t.currentTarget,"filelist"),!$e){var a=tools.getTarget(t);if(a.className.indexOf("docProo")>-1&&function(t){N=!1,e=t.id.slice("docPro_".length,t.id.length),console.log(e),local_api.getTableColumns("docProp",$.cookie("appkey"),function(t){t.err||(I=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),t.row.forEach(function(e){-1==D.indexOf(e.Field)&&$("#someProp").append('<option value="'+e.Field+'">'+e.Field+"</option>")})),local_api._get("docProp",{fid:e},"",$.cookie("appkey"),function(e){if(console.log(e),0==e.status){if(e.data){for(var t in S=!1,$("#name").val(e.data.name),$("#saveExpireIn").val(e.data.saveExpireIn),$("#createdAt").val(e.data.createdAt),$("#num").val(e.data.num),$("#page").val(e.data.page),$("#did").val(e.data.did),$("#qnum").val(e.data.qnum),$("#lnum").val(e.data.lnum),$("#jnum").val(e.data.jnum),$("#cnum").val(e.data.cnum),$("#ce").val(e.data.ce),$("#newPropLi").empty(),e.data)if(-1==D.indexOf(t)&&e.data[t]){var a=document.createElement("li");a.style.marginTop="10px",a.dataset=t;var o=' \n                                        <label class="ellipsis" title="'+t+'">'+t+'</label>\n                                        <input value="'+e.data[t]+'" class="form-control" style="width:60%"/>\n                                    ';a.innerHTML=o,$("#newPropLi").append(a)}}else S=!0,$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0);$("#divDocPro").dialog("open")}})})}(t.target),a.className.indexOf("openProo")>-1&&function(e){createOperate("打开密集柜");var t=e.id.slice("openProo_".length,e.id.length);local_api._get("docProp",{fid:t},"",$.cookie("appkey"),function(e){if(e.data){var t=parseInt(e.data.qnum||0),a=parseInt(e.data.lnum||0),o=parseInt(e.data.jnum||0),n=parseInt(e.data.cnum||0),i=parseInt(e.data.ce||0),l=parseInt(e.data.bnum||1);if(t>0&&a>0&&o>0&&n>0&&i>=0){var c={qu:t,lie:a,jie:o,ceng:n,ce:i,bh:l,name:e.data.did,status:1};local_api._delete("playApp",{id:">0"},$.cookie("appkey"),function(e){local_api._create("playApp",c,$.cookie("appkey"),function(e){var t=e.id;q&&clearInterval(q),q=setInterval(function(){local_api._get("playApp",{id:t},"",$.cookie("appkey"),function(e){1!=e.data.status&&(clearInterval(q),2==e.data.status?showTips("ok","打开成功！"):3==e.data.status?showTips("err","密集柜连接失败，请检查是否已连接！"):showTips("err","打开失败，请重新打开！"))})},1e3)})})}else showTips("err","无位置信息，无法打开密集柜！")}else showTips("err","无位置信息，无法打开密集柜！")}),console.log(t)}(t.target),a.className.indexOf("folder")>-1||function(e){var t=parseInt(e.target.dataset.type);if([0,1,2,4].indexOf(t)>-1)return!0;if("file-title"==e.target.className){var a=parseInt(e.target.parentNode.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}if("file-title-box"==e.target.className){var a=parseInt(e.target.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}return!1}(t)){if(r=$(".file-list").scrollTop(),tools.parents(a,".item")){var o=(a=tools.parents(a,".item")).dataset.fileId;u=o,$.cookie("contentId",u);var n=$.fn.zTree.getZTreeObj("tree-menu"),i=n.getNodeByParam("id",u,null);i&&(s=i.treePath,d=i.u_path,n.selectNode(i)),J(o)}}else{console.log($(".item",t.currentTarget).data());var l=$(".item",t.currentTarget).data(),c=l.filepath,p=c.slice(c.lastIndexOf("."),c.length);if(3==l.type&&".pdf"==p&&(f="/pdfView?fileid="+l.fileId,window.open(f,"_blank")),3==l.type&&/\.(?:xls|xlsx|doc|docx)$/.test(p)){console.log(l);var f="/upload/"+g(l.tree_path)+$(".item .file-title",t.currentTarget).text();window.open(f,"_self")}}}},Z=function(e){var t=tools.getTarget(e);if(tools.parents(t,"a")){var a=t.dataset.fileId;u=a,$.cookie("contentId",u);var o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("id",u,null);n&&(s=n.treePath,d=n.u_path,o.selectNode(n)),J(a)}},U=function(){$(document).off("click",".file-list .file-item",Y),tools.removeEvent(T,"click",Z)};var R={0:"./img/icon-file-s.svg",1:"./img/icon-file-s.svg",2:"./img/icon-file-s1.svg",4:"./img/icon-file-s2.svg"};function J(e){r&&setTimeout(function(){$(".file-list")[0].scrollTop=r},1e3),k=[],t.forEach(function(t){t.id==e&&(1==t.type||0==t.type?($("#folder1").show(),$("#folder2").show(),$("#folder3").hide()):($("#folder1").hide(),$("#folder2").hide(),$("#folder3").show()),k.push(t))});var a={pid:e,u_path:"^"+d};-1==roleArr.indexOf("访问加锁文档")&&(a.islock="<>2"),local_api._list("document",a,"",m,1,-1,$.cookie("appkey"),function(a){$(".file-list").empty();var o=!!a.total;k=k.concat(a.data),console.log(o),o?(E.style.display="none",P.innerHTML=createFilesHtml(k,e)):(E.style.display="block",P.innerHTML=""),T.innerHTML=createPathNavHtml(t,e),K=tools.$(".file-item",P),tools.each(K,function(e,t){te(e)}),tools.removeClass(Q,"checked"),u=e,$.cookie("contentId",u)})}tools.addEvent(tools.$(".mod-action-wrap")[1],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(W(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",V)):void 0});var V=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;W(),tools.removeEvent(document,"mouseover",V)}};function W(){tools.$("#btn-change .action-item-con").forEach(function(e){e.style.background="#fff"}),tools.$("#btn-change .act-txt").forEach(function(e){e.style.display="none"})}for(var G=0;G<tools.$(".mod-action-wrap")[1].children.length;G++)tools.addEvent(tools.$(".mod-action-wrap")[1].children[G],"click",function(e){console.log(tools.hasClass(this,"act")),this==tools.$(".mod-action-wrap")[1].children[0]?tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[1].className="action-item",tools.addClass(tools.$(".file-list")[0],"f_detail")):tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[0].className="action-item",tools.removeClass(tools.$(".file-list")[0],"f_detail"))});var K=tools.$(".file-item",P),Q=tools.$(".cheched-all")[0],ee=tools.$(".checkbox",P);function te(e){var t=tools.$(".checkbox",e)[0];tools.addEvent(e,"mouseenter",function(){tools.addClass(this,"file-checked")}),tools.addEvent(e,"mouseleave",function(){tools.hasClass(t,"checked")||tools.removeClass(this,"file-checked")}),tools.addEvent(t,"click",function(e){console.log(e,"thischeck"),ee=tools.$(".checkbox",P),tools.toggleClass(this,"checked")?ae().length==ee.length&&tools.addClass(Q,"checked"):tools.removeClass(Q,"checked"),tools.stopPropagation(e)})}function ae(){var e=[];return tools.each(ee,function(t,a){tools.hasClass(t,"checked")&&e.push(K[a])}),e}tools.each(K,function(e,t){te(e)}),console.log($(".file-list .checkbox")),tools.addEvent(Q,"click",function(e){K=tools.$(".file-item",P),ee=tools.$(".checkbox",P),tools.toggleClass(this,"checked")?tools.each(K,function(e,t){tools.addClass(e,"file-checked"),tools.addClass(ee[t],"checked")}):tools.each(K,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked")})}),tools.addEvent(tools.$(".mod-action-wrap")[0],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(ne(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",oe)):void 0});var oe=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;ne(),tools.removeEvent(document,"mouseover",oe)}};function ne(){tools.$(".mod-nav .action-item-con").forEach(function(e){e.style.background="#fff"}),tools.$(".mod-nav .act-txt").forEach(function(e){e.style.display="none"})}var ie=null,le=null,ce=0;ce=0;tools.addEvent(tools.$(".main")[0],"mousedown",function(e){var t=tools.getTarget(e);tools.parents(t,".nav-a")||(ce=e.clientX,disY=e.clientY,tools.addEvent(document,"mousemove",de),tools.addEvent(document,"mouseup",pe),e.preventDefault())});var se=!1;function re(e){if(console.log(e.target),e.target,!le){le=document.createElement("div"),document.body.appendChild(le);$(le).css({position:"fixed",width:"150px",height:"40px"});var t='<div class="selectboxMoveone">\n                        <div>\n                            <span></span>\n                            <span class="ellipsis">'+$(".file-title",ae()[0]).text()+'</span>\n                        </div>\n                        <span class="moveleng">'+ae().length+"</span>\n                    </div>\n                    "+(ae().length>1?'<div class="selectboxMovemore"></div>':"")+"\n                    ";$(le).append(t)}$(le).css({top:e.clientY+2,left:e.clientX+2})}function de(e){function t(){Math.abs(e.clientX-ce)>20||Math.abs(e.clientY-disY)>20?(ie||(ie=document.createElement("div"),document.body.appendChild(ie),ie.className="select-box"),console.log(ie,"hi"),ie.style.display="block",ie.style.width=Math.abs(e.clientX-ce)+"px",ie.style.height=Math.abs(e.clientY-disY)+"px",ie.style.left=Math.min(e.clientX+2,ce-2)+"px",ie.style.top=Math.min(e.clientY+2,disY-2)+"px",tools.each(K,function(e,t){tools.collisionRect(ie,e)?(tools.addClass(e,"file-checked"),tools.addClass(ee[t],"checked")):(tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked"))}),ae().length==ee.length?tools.addClass(Q,"checked"):tools.removeClass(Q,"checked")):ie&&(ie.style.display="none")}le?re(e):(se?ae().indexOf(e.target.parentNode)>-1?re(e):function e(t,a,o){var o=o;var n=$(t).parent()[0];"BODY"==n.nodeName?o(!1):n.className.indexOf(a)>-1?o(n):e(n,a,o)}(e.target,"file-item",function(a){console.log(a,"paen"),a&&ae().indexOf(a)>-1?re(e):(se=!1,t())}):t(),K=tools.$(".file-item",P),ee=tools.$(".checkbox",P))}function pe(e){if(tools.removeEvent(document,"mousemove",de),tools.removeEvent(document,"mouseup",pe),ie&&(ie.style.display="none"),se=!se,le)se=!0,$(le).remove(),le=null,function(e){if(e.target.id.indexOf("tree-menu")>-1){var t=e.target.id.split("_"),a=t[0]+"_"+t[1],o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("tId",a,null);n&&(assignFid=n.id,assignTreePath=n.treePath,assignU_path=n.u_path,assignPath=n.path,F())}}(e);else if(console.log(f),ie)$(ie).remove(),ie=null;else{var t=e.target.parentNode.className;"nav"!=t&&"file-show"!=t&&"content clearfix"!=t||(tools.each(K,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked")}),tools.removeClass(Q,"checked"),se=!1)}}var ue,fe=tools.$(".create")[0];function he(e){E.style.display="none";var t=P.firstElementChild,a=createFileElement({title:"",id:(new Date).getTime(),type:e,name:""});P.insertBefore(a,t);var o=$(".file-title",a);o.css("display","none"),o.parent().append('<span class="file-edtor"> <input type="text" value="" class="edtor" autofocus="autofocus"></span>');var n=$(".edtor",a);n.focus(),$(".file-edtor",a).on("mousedown",function(e){e.stopPropagation()}),$(n).on("keyup",function(e){13==e.keyCode&&me()}),fe.isCreateFile=!0,tools.addEvent(document,"mousedown",me)}function me(e){if(createOperate("新建"),fe.isCreateFile){var t=P.firstElementChild,a=tools.$(".edtor",t)[0].value.trim();if(""===a)P.removeChild(t),""===P.innerHTML&&(E.style.display="block");else{var o=tools.$(".file-title",t)[0],n=$(".file-edtor",t);console.log(t),o.style.display="block",o.innerHTML=a,n.remove();var i={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,name:a,type:ue,u_path:d};local_api._create("document",i,$.cookie("appkey"),function(e){var t=s+","+e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){X(p),2==ue?showTips("ok","新建案卷成功!"):1==ue?showTips("ok","新建分类成功!"):4==ue&&showTips("ok","新建组成功!")})})}fe.isCreateFile=!1,tools.removeEvent(document,"mousedown",me)}}$(".create").on("click",function(){$(".create_file").toggleClass("act")}),$(document).on("mousedown",function(){$(".create_file").hasClass("act")&&$(".create_file").toggleClass("act")}),$("#folder1").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=1,he(1)}),$("#folder2").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=2,he(2)}),$("#folder3").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=4,he(4)});var ve=tools.$(".rename")[0],$e=!1;tools.addEvent(ve,"mouseup",function(){if(K=tools.$(".file-item",P),ee=tools.$(".checkbox",P),createOperate("重命名"),ae().length)if(ae().length>1)showTips("err","只能对单个文件重命名！");else{var e=function(t){if(!t||(t.stopPropagation(),t.preventDefault(),t.target.parentNode!=s)){var l=c.val().trim();if(""==l)showTips("err","请输入文件名！");else{var r,d,u=g(o);3==n?(r=u+i,d=u+l):(r=u,d=u.slice(0,u.lastIndexOf(i))+l),console.log(u);var f={type:1,oldPath:r,newPath:d};local_api._rename(f,$.cookie("appkey"),function(e){console.log(e),setTimeout(function(){return $e=!1},2e3),0==e.status?local_api._update("document",{id:a},{name:l},$.cookie("appkey"),function(e){0==e.status&&(showTips("ok","重命名成功"),X(p))}):(showTips("err",e.message),X(p))})}tools.removeEvent(document,"mousedown",e)}},t=$(".file-checked .file-title"),a=$(".file-checked .item").data().fileId,o=$(".file-checked .item").data().tree_path,n=$(".file-checked .item").data().type;if(console.log($(".file-checked .item").data()),0!=$(".file-checked .item").data().type){$e=!0;var i=t.attr("title"),l='<span class="file-edtor"> <input type="text" value="'+i+'" class="edtor"></span>';t.css("display","none"),t.parent().append(l);var c=$(".file-checked .edtor"),s=$(".file-checked .file-edtor")[0];c.select(),$(".file-checked .file-edtor").on("mousedown",function(e){e.stopPropagation()}),c.on("keypress",function(t){13==t.keyCode&&e()}),tools.addEvent(document,"mousedown",e)}else showTips("err","无法对客户文件夹进行重命名!")}else showTips("err","请选择文件！")}),tools.addEvent(tools.$(".nav-box")[0],"click",function(e){console.log(tools.getTarget(e)),console.log(tools.getTarget(e).parentNode),tools.hasClass(tools.getTarget(e).parentNode,"nav-list")&&(tools.each(tools.$(".nav-list.nav-current"),function(e){console.log(e.className),tools.removeClass(e,"nav-current")}),tools.addClass(tools.getTarget(e).parentNode,"nav-current")),console.log(tools.hasClass(tools.getTarget(e).parentNode,"nav-list"))}),tools.addEvent(tools.$("#search")[0],"focus",function(){var e=tools.$("#_search_bar")[0];tools.addClass(e,"focus")}),tools.addEvent(tools.$("#search")[0],"blur",function(){var e=tools.$("#_search_bar")[0];setTimeout(function(){tools.removeClass(e,"focus")},200)}),$("#search").on("keypress",function(e){createOperate("文件检索"),13==e.keyCode&&""!=e.target.value.trim()&&(location.href="/hightSearch?query="+e.target.value.trim())});$(".upload").on("click",function(e){e.stopPropagation(),_e()}),$(".upload-file").on("click",function(e){e.stopPropagation();var t=e.target.parentNode,a=e.target.parentNode.parentNode,o=$(".upload-file").children().children();t!=o[0]&&a!=o[0]||_e()});var ge={"01":"01_履历材料","02":"02_自传材料","03":"03_鉴定、考核、考察、审计材料","04":"04_学历、学位、专业技术和培训等材料","05":"05_政审材料","06":"06_参加党团的材料","07":"07_表彰奖励材料","08":"08_涉纪涉法处分材料","09":"09_工资、任免、出国、代表大会等材料",10:"10_其他供参考材料"};function _e(){createOperate("文件上传");var e=document.createElement("input");e.type="file",e.multiple="multiple",$(e).change(function(e){console.log(this.files);var t=this.files,c=o.length+0;$(".mod-tasks .tasks-header").removeClass("result-succt").addClass("tasking-nor");var r=s.split(","),f="";function m(e){$(e).on("click",function(e){console.log(e);var t=e.currentTarget.dataset.file_id;console.log(t),$(e.currentTarget).hasClass("waiting")&&$(e.target).hasClass("btn-icon")&&(l.push(parseInt(t)),v(3,t)),$(e.currentTarget).hasClass("cancel")&&$(e.target).hasClass("btn-icon")})}function v(e,t){var n=o[t],l=uploadHtml(e,n,t);m(l),$(a[t],i).replaceWith(l),a.splice(t,1,l)}function _(e,t,o,n){var i=new FormData;i.append(e.last_name,o);var l="/upload?path="+encodeURI(g(e.tree_path));http({type:"POST",url:l,data:i,onProgress:function(e){console.log(e.percent),$(".task-txt-status",a[c]).text(e.percent.toFixed(2)+"%")},onSuccess:function(a){console.log(a),a.fmd5=t,0==a.status?function(e,t,a){var o={pid:t.id,size:e.file.size,type:3,name:e.file.filename};t.hb?(console.log(t.hb),local_api._rename(t.hb.rename,$.cookie("appkey"),function(o){0==o.status?local_api._fsCombind(t.hb.combind,$.cookie("appkey"),function(o){if(0==o.status){var n={id:t.hb.id,tree_path:t.hb.tree_path},i=parseInt(t.hb.size)+parseInt(e.file.size);local_api._update("document",{id:t.hb.id},{size:i},$.cookie("appkey"),function(e){a(n)})}else local_api._update("document",{id:t.hb.id},{name:t.hb.newname},$.cookie("appkey"),function(e){a({})})}):a({})})):local_api._get("document",o,"",$.cookie("appkey"),function(o){if(0!=o.status||o.data){if(0==o.status&&o.data){var n={id:o.data.id,tree_path:o.data.tree_path};a(n)}}else{var i=e.file.mimetype.indexOf("image")>-1?"png":"txt",l=t.tree_path.split(",")[t.tree_path.split(",").length-1];l==t.id&&(l=t.id);var c={size:e.file.size,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:l,type:3,filetype:i,name:e.file.filename,path:"/upload/"+g(t.tree_path)+e.file.filename,f_md5:e.fmd5,u_path:d,ispass:1,islock:1};local_api._create("document",c,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n={id:e.id,tree_path:o};local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){a(n)})})}})}(a,e,function(e){n(e)}):n(a)},onError:function(e){n(res)}})}dataControl.getParents(h,r[r.length-1]).reverse().forEach(function(e){f+=e.name+"/"}),f,Array.prototype.forEach.call(t,function(e,t){console.log(e),$(".mod-tasks").show();var n=uploadHtml(0,e,c+t);m(n),a.push(n),o.push(e),i.append(n)}),function e(){var t=o[c];if(l.indexOf(c)>-1)return c++,void e();if(o.length==c)$(".mod-tasks .tasks-header").removeClass("tasking-nor").addClass("result-succ"),$(".mod-tasks .summary-wrapper .txt").text("任务已完成  "+n+"项任务失败"),$(".title-wrapper h2.title").text("任务已完成  "+n+"项任务失败");else{var i=(c/o.length).toFixed(1);$(".mod-tasks .summary-wrapper .before").css("transform","scaleX("+i+")"),$(".mod-tasks .summary-wrapper .txt").text(c+"/"+o.length+"项任务进行中  "+n+"项任务失败"),$(".title-wrapper h2.title").text(c+"/"+o.length+"项任务进行中  "+n+"项任务失败")}t&&function(e,t,a){get_filemd5sum(e,function(t){var o=e.name;!function(e,t){var a=e.indexOf("【"),o=e.indexOf("】");if(a>-1&&o>0){var n=e.slice(a+1,o).trim(),i=e.slice(o+1,e.length).trim(),l=n.split("_");l=l.map(function(e){return e.trim()});var c=s.split(",")[s.split(",").length-1];c==u&&(c=u);var r={did:l[0],name:l[0]+l[1],tree_path:"^"+s,pid:c};local_api._get("document",r,"",$.cookie("appkey"),function(e){if(0==e.status&&e.data)if(l[2]){var a={name:l[2],tree_path:"^"+e.data.tree_path,pid:e.data.id};local_api._get("document",a,"",$.cookie("appkey"),function(a){if(0==a.status&&a.data)t(Object.assign(a.data,{last_name:i}));else if(0==a.status){var o={name:l[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:e.data.id,u_path:d};local_api._create("document",o,$.cookie("appkey"),function(a){var o=e.data.tree_path+","+a.id,n={id:a.id,tree_path:o,last_name:i};local_api._update("document",{id:a.id},{tree_path:o},$.cookie("appkey"),function(e){t(n)})})}else t({status:-1})})}else t(Object.assign(e.data,{last_name:i}));else if(1==l.length){var o={name:l[0],did:l[0],type:2,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:c,u_path:d};local_api._create("document",o,$.cookie("appkey"),function(e){var a=s+","+e.id,o={id:e.id,tree_path:a,last_name:i};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(a){var n={fid:e.id,name:l[0],did:l[0],u_path:d};local_api._create("docProp",n,$.cookie("appkey"),function(e){t(o)})})})}else t({status:-1})})}else{var p=e.split("_");if(p.length>1){var f=h.filter(function(e){return e.did==p[0]});if(f.length){var m={id:f[0].id,tree_path:f[0].tree_path,last_name:ge[p[1].split(".")[0]]+".pdf"};t(m)}else t({status:-1})}else{var m={id:u,tree_path:s,last_name:e};t(m)}}}(o,function(o){-1!=o.status?B(function(){var n="",i=o.last_name,l="",c=0;i.lastIndexOf(".")>-1?(n=i.slice(0,i.lastIndexOf(".")),l=i.slice(i.lastIndexOf("."))):(n=i,l="");var s=t;if(-1!=s){var r=function(){c++;var t={name:i,tree_path:"^"+o.tree_path,type:3};local_api._get("document",t,"",$.cookie("appkey"),function(t){if(0==t.status&&t.data){if(t.data.f_md5==s)a(t.data);else if(i=n+c+l,r(),".pdf"==l){var d=g(t.data.tree_path)+t.data.name,p=g(t.data.tree_path)+n+"99"+l,u=g(t.data.tree_path)+i;o.hb={rename:{type:1,oldPath:d,newPath:p},combind:{input:{0:p,1:u},output:d},id:t.data.id,tree_path:t.data.tree_path,name:t.data.name,newname:n+"99"+l,size:t.data.size}}}else 0!=t.status||t.data||(o.last_name=i,_(o,s,e,a))})};r()}}):a({})})})}(t,0,function(t){t.id?(v(1,c),$(".task-txt-status",a[c]).text("100%")):(n++,v(2,c)),c++,t.name||X(p),e()})}()}),e.click()}function ke(){m.split("|").forEach(function(e){var t=e;e.indexOf("-")>-1&&(t=e.slice(1,e.length));var a,o="__"+t;$("#"+o).prop("checked",!0),a=e.indexOf("-")>-1?$("label",$("#"+o).parent()).attr("value")+"↑":$("label",$("#"+o).parent()).attr("value")+"↓",$("label",$("#"+o).parent()).text(a)});var e=$("#divDocSort input:not(:checked) ").not('input[name="sort"]'),t=$("#divDocSort input:radio:checked").val();e.each(function(e,a){var o;2==t?o=$("label",$(a).parent()).attr("value")+"↓":1==t&&(o=$("label",$(a).parent()).attr("value")+"↑"),$("label",$(a).parent()).text(o)})}$(".delete").on("click",function(e){console.log(ae());var t=ae();if(ae().length){var a=[],o=[],n={},i=[],l=[];t.forEach(function(e){var t=$(".item",e).data().type,c={};if(0!=t?(a.push("^"+$(".item",e).data().tree_path),3==t?(c.tree_path="^"+$(".item",e).data().tree_path,c.path=g($(".item",e).data().tree_path)+$(".item .file-title",e).text()):(c.tree_path="^"+$(".item",e).data().tree_path,c.path=g($(".item",e).data().tree_path)),l.push(c)):o.push("^"+$(".item",e).data().tree_path),!n[t]){n[t]=1;var s=1==t?"分类":2==t?"案卷":3==t?"文件":"";i.push(s)}}),createOperate("文件删除"),console.log(l),o.length>0&&showTips("err","无法对客户文件夹进行删除操作");var c="确定要删除"+(t.length>1?"这些":"这个")+i.join("/")+"？";a.length&&confirm(c)&&l.forEach(function(e,t){local_api._fsDelete({curPath:e.path},$.cookie("appkey"),function(a){0==a.status&&local_api._delete("document",{tree_path:e.tree_path},$.cookie("appkey"),function(e){t==l.length-1&&(X(p),showTips("ok","删除"+i.join("/")+"成功!"))})})})}else showTips("err","请选择文件或档案！")}),$(".logout").on("mousedown",function(e){e.stopPropagation(),location.href="/logout"}),$("#showList").click(function(){$(".mod-tasks").toggleClass("expand")}),$("#hideList").click(function(){$(".mod-tasks").hide(),a=[],o=[],n=0,i.empty(),fileIndex=0}),$("#divCombind").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){!function(){var e={handle_json:{input:{},output:""},update:{path:"",name:"",size:""},query:{id:""},delete_j:{id:""}},t=[],a=ae();a.length?a.forEach(function(e){var a=$(".item",e).data();a.name=$(".item .file-title",e).text(),a.size=backFileSize($(".item ul>li:nth-child(1)",e).text()),t.push(a)}):showTips("err","请选择pdf文件进行合并！");if(!t.length)return void showTips("err","请选择pdf文件进行合并！");var o=0,n=[];t.forEach(function(t,a){o+=t.size,e.handle_json.input[a]=g(t.tree_path)+t.name,0==a?(e.query.id=t.fileId,e.update.name=$("#renameCombind").val().trim()+".pdf",e.update.path="/upload/"+g(t.tree_path)+$("#renameCombind").val().trim()+".pdf",e.handle_json.output=g(t.tree_path)+$("#renameCombind").val().trim()+".pdf"):n.push(t.fileId)}),e.delete_j.id=n.join("|"),e.update.size=o,createOperate("合并文件"),confirm("确定合并已选择的文件")?local_api._fsCombind(e.handle_json,$.cookie("appkey"),function(t){0==t.status?local_api._update("document",e.query,e.update,$.cookie("appkey"),function(t){local_api._delete("document",e.delete_j,$.cookie("appkey"),function(e){showTips("ok","合并成功!"),$("#divCombind").dialog("close"),J(u)})}):(showTips("err","合并失败!"),$("#divCombind").dialog("close"))}):$("#divCombind").dialog("close")}()},"取消":function(){$("#divCombind").dialog("close")}}}),$("#combind").on("click",function(){$("#divCombind").dialog("open")}),$("#divDocSort").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){X(p),$("#divDocSort").dialog("close")},"取消":function(){$("#divDocSort").dialog("close")}}}),$("#sort").on("click",function(){ke(),$("#divDocSort").dialog("open")}),$("#divDocSort input").change(function(){var e=m.split("|"),t=$("#divDocSort input:radio:checked").val();if("sort"!==$(this).attr("name"))if($(this).attr("checked"))2==t?e.push($(this).val()):1==t&&e.push("-"+$(this).val());else{var a=e.indexOf($(this).val())>-1?e.indexOf($(this).val()):e.indexOf("-"+$(this).val());console.log(a),e.splice(a,1)}m=e.join("|"),console.log(e,m,"dd"),ke()}),$("#divDocImport").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择分类",buttons:{"确定":function(){console.log($("#DocImport").val());var e=$("#DocImport").val(),t=document.createElement("input");t.type="file",$(t).change(function(t){var a=$(this)[0].files;1==e?ye(a):2==e&&we(a),$("#divDocImport").dialog("close")}),t.click()},"取消":function(){$("#divDocImport").dialog("close")}}}),$("#export").click(function(){$("#divDocImport").dialog("open")}),$("#exportPorp").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){$(this)[0].files}),e.click()});var ye=function(e){createOperate("导入台账");var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}),o=a.SheetNames,n={},i=h.filter(function(e){return 1==e.type&&e.tree_path.indexOf(s)>-1});for(var l in o.forEach(function(e,t){i.forEach(function(t){e.trim()==t.name&&(console.log(t),n[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),n)c(l,n[l].id,n[l].tree_path);function c(e,t,o){var n=a.Sheets[e],i=_(n["!ref"]),l=[];for(var c in n){var s=[];c.split("").forEach(function(e){/^[A-Z]+$/.test(e)&&s.push(e)}),s.join("")&&-1==l.indexOf(s.join(""))&&l.push(s.join(""))}for(var r=[],u=[],f=["createdAt","saveExpireIn","page","num","did","name","具体地址","位置","社区单位编号","是否建档","经营状态"],h=5;h<i;h++){var m={u_path:d},v={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t,type:2,u_path:d};l.forEach(function(e){if(n[e+h]){var t=n[e+3]?n[e+3].v:n[e+4]?n[e+4].v:"";switch(t){case"建档时间":t="createdAt";break;case"保管期限":t="saveExpireIn";break;case"页数":t="page";break;case"文书份数":t="num";break;case"企业名称":t="name";break;case"档号":case"档案编号":t="did"}if("name"==t&&(v.name=n[e+h].v),"did"==t&&(v.did=n[e+h].v),f.indexOf(t)>-1)if("位置"==t){var a=n[e+h].v.split("_");6==a.length&&(m.qnum=a[0],m.lnum=a[1],m.ce=a[2],m.jnum=a[3],m.cnum=a[4],m.bnum=a[5])}else m[t]=n[e+h].v}}),m.name&&u.push(v),m.name&&r.push(m)}console.log(u,r);var g=0,k=function(){var t=u[g],a=r[g];if(g++,t){var n=Object.assign({},t);delete n.createdAt,n.name=n.did+n.name,local_api._get("document",n,"",$.cookie("appkey"),function(e){console.log(n,e.data,!!e.data),0!=e.status||e.data?k():(t.name=t.did+t.name,t.ispass=1,t.islock=1,console.log(t,a,"ddf______________"),k(),local_api._create("document",t,$.cookie("appkey"),function(e){var t=o+","+e.id,n=e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){var t=a;t.fid=n,local_api._create("docProp",t,$.cookie("appkey"),function(e){k()})})}))})}else X(p),showTips("ok","导入"+e+"成功")};return k(),{createDoc:u,createArr:r}}console.log(n,"")}},we=function(e){var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}),o=a.SheetNames,n={},i=h.filter(function(e){return 1==e.type&&e.tree_path.indexOf(s)>-1});for(var l in o.forEach(function(e,t){i.forEach(function(t){e.trim()==t.name&&(console.log(t),n[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),n)c(l,n[l].id,n[l].tree_path);function c(e,t,o){var n=a.Sheets[e],i=_(n["!ref"]),l=[];for(var c in n){var s=[];c.split("").forEach(function(e){/^[A-Z]+$/.test(e)&&s.push(e)}),s.join("")&&-1==l.indexOf(s.join(""))&&l.push(s.join(""))}var r=[],u=[];console.log(i);for(var f=2;f<i;f++){var m={u_path:d},v={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t,type:2,u_path:d};l.forEach(function(e){if(n[e+f]){var t=n[e+1]?n[e+1].v:n[e+2]?n[e+2].v:"";switch(t){case"类别":var a=h.filter(function(t){return t.name==n[e+f].v});console.log(a,"dd"),a.length>0&&(v.pid=a[0].id,v.tree_path=a[0].tree_path);break;case"姓名":t="name";break;case"档案号":t="did"}m[t]=n[e+f].v,"name"==t&&(v.name=n[e+f].v),"did"==t&&(v.did=n[e+f].v)}}),m.name&&u.push(v),delete m["序号"],delete m["类别"],m.name&&r.push(m)}console.log(u,r);var g=0,k=function(){var t=u[g],a=r[g];if(g++,t){var o=Object.assign({},t);delete o.createdAt,o.name=o.name,local_api._get("document",o,"",$.cookie("appkey"),function(e){console.log(o,e.data,!!e.data),0!=e.status||e.data?k():(t.name=t.name,t.ispass=1,t.islock=1,console.log(t,a,"ddf______________"),local_api._create("document",t,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n=e.id;local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){var t=a;console.log(e,"up"),t.fid=n,local_api._create("docProp",t,$.cookie("appkey"),function(e){console.log(e,"docP"),k()})})}))})}else X(p),showTips("ok","导入"+e+"成功")};k()}console.log(n,"")}}}function g(e){var t="";return e.split(",").filter(function(e){return""!=e}).forEach(function(e){h.forEach(function(a){e==a.id&&(t+=a.name+"/")})}),""==t&&(t="nodelete/"),t}function _(e){for(var t=e.split(""),a=0,o="",n=t.length-1;n>0;n--)if(/^[A-Z]+$/.test(t[n])){a=n+1;break}for(n=a;n<t.length;n++)o+=t[n];return parseInt(o)}!function(){d=$.cookie("tree_path");var e,t,k,y=tools.$(".header")[0],w=tools.$(".weiyun-content")[0],b=y.offsetHeight,x=tools.$(".content")[0],P=tools.$(".file-list")[0];tools.$(".tree-menu")[0];var T=tools.$(".path-nav")[0],E=tools.$(".g-empty")[0];function C(){var e=window.innerHeight||document.documentElement.clientHeight;w.style.height=e-b+"px",x&&(x.style.height=e-b-62+"px"),P&&(P.style.height=e-b-93+"px")}function O(){var e="";return[1,2,3,4,5,6,7,8,9].forEach(function(t){e+='<option value="'+t+'">'+t+"</option>"}),e}$.cookie("uid"),C(),window.onresize=C,$("#qnum").empty().append(O()),$("#lnum").empty().append(O()),$("#jnum").empty().append(O()),$("#cnum").empty().append(O());var I=[],D=["id","fid","u_path","did","name","saveExpireIn","createdAt","num","page","qnum","lnum","jnum","cnum","ce","bnum","pname","lname"];function j(e){var t=document.createElement("li");t.style.marginTop="10px",t.dataset=e;var a=' \n            <label class="ellipsis" title="'+e+'">'+e+'</label>\n            <input value="" class="form-control" style="width:50%"/>\n            <button class="btn btn-primary newBtn" style="">删除</button>\n        ';t.innerHTML=a,$("#newPropLi").append(t),console.log($(t)),$("button",t).on("click",function(t){console.log(e),I.splice(I.indexOf(e),1),$(t.target).parent().remove()})}$("#divDocPro").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"保存":function(){N?function(){if(console.log(L),L.length){for(var e=[],t={u_path:d,name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),did:$("#did").val(),num:$("#num").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}L.forEach(function(a){var n=Object.assign({},t,o);n.fid=a,e.push(n)}),confirm("批量设置属性会覆盖案卷原有属性，是否批量设置属性")&&local_api._delete("docProp",{fid:L.join("|")},$.cookie("appkey"),function(t){console.log(t),local_api._createBatch("docProp",{data:JSON.stringify({data:e})},$.cookie("appkey"),function(e){createOperate("批量设置案卷属性"),$("#divDocPro").dialog("option","title","属性"),$("#divDocPro").dialog("close")})}),console.log(e)}else showTips("err","该档案下没有案卷可设置")}():function(){if(createOperate("单个设置属性"),S){for(var t={name:$("#name").val(),fid:e,u_path:d,saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(t,o),console.log(t),local_api._create("docProp",t,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}else{var l={name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},c={fid:e};for(a=$("#newPropLi li"),o={},n=0;n<a.length;n++){i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(l,o),console.log(l),local_api._update("docProp",c,l,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}}()},"取消":function(){$("#divDocPro").dialog("close")}}}),$("#selectProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择自定义属性",buttons:{"确定":function(){$("#selectProp").dialog("close")}}}),$("#newCustomProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"添加新属性",buttons:{"确定":function(){var e;e=$("#newPropname").val(),local_api._createColumn("docProp",{name:e,size:50},"",function(t){createOperate("添加自定义属性"),t.err?showTips("err","添加属性失败"):(j(e),I.push(e),$("#someProp").append('<option value="'+e+'">'+e+"</option>"),$("#newCustomProp").dialog("close"))})},"取消":function(){$("#newCustomProp").dialog("close")}}}),$("#someProp").on("change",function(e){console.log(this.value),0!=this.value&&(-1==I.indexOf(this.value)?(I.push(this.value),j(this.value)):showTips("err","该属性已存在"))}),$("#newProp").click(function(){$("#newCustomProp").dialog("open")}),$("#addCustom").click(function(){$("#selectProp").dialog("open")});var N=!1,A=[],M=[],H=[],L=[];$("#someProo").on("click",function(){N=!0,A=[],M=[],H=[],L=[],console.log(ae()),ae().length?(ae().forEach(function(e){3!=$(".item",e).data().type&&(A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path),H.push($(".item .file-title",e).text()))}),console.log(A,M,H),local_api.getTableColumns("docProp",$.cookie("appkey"),function(e){e.err||(I=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),e.row.forEach(function(e){-1==D.indexOf(e.Field)&&$("#someProp").append('<option value="'+e.Field+'">'+e.Field+"</option>")})),local_api._list("document",{tree_path:M.join("|"),type:2},"","",1,-1,$.cookie("appkey"),function(e){$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0),$("#divDocPro").dialog("option","title","批量设置属性"),$("#divDocPro").dialog("open"),e.data.forEach(function(e){L.push(e.id)})})})):showTips("err","请选择文件！")});var q,S=!1;function z(){for(var e=ae(),t={tree_path:[],id:[]},a=0;a<e.length;a++)t.tree_path.push("^"+$(".item",e[a]).data().tree_path),t.id.push($(".item",e[a]).data().fileId);return t}function F(){createOperate("移动");var e=z().tree_path,t=z().id;console.log(assignFid,assignTreePath,assignU_path);var a=[];local_api._list("document",{tree_path:e.join("|")},"","",1,-1,$.cookie("appkey"),function(e){e.data.forEach(function(o){var n={};if(n[o.id]={},t.indexOf(o.id)>-1){var i=function(t,o){var n=dataControl.getChildById(e.data,t);n.length&&n.forEach(function(e){var n={};n[e.id]={},n[e.id].pid=t,n[e.id].oldtree_path=e.tree_path;var l=o+","+e.id;n[e.id].tree_path=l,n[e.id].olePath=g(e.tree_path),n[e.id].newPath=g(l),n[e.id].u_path=assignU_path,n[e.id].name=e.name,n[e.id].type=e.type,a.push(n),i(e.id,l)})};n[o.id].pid=assignFid;var l=o.tree_path.indexOf(o.id),c=o.tree_path.length,s=assignTreePath+","+o.tree_path.slice(l,c);n[o.id].oldtree_path=o.tree_path,n[o.id].tree_path=s,n[o.id].olePath=g(o.tree_path),n[o.id].newPath=g(s),n[o.id].u_path=assignU_path,n[o.id].name=o.name,n[o.id].type=o.type,a.push(n),i(o.id,s)}}),console.log(a),$("#divDocumentAssign").dialog("close"),function e(t,a){console.log(t[a]);var o=t[a];for(var n in o)if(3==o[n].type){var i={oldPath:o[n].olePath,newPath:o[n].newPath,name:o[n].name,type:2};local_api._rename(i,$.cookie("appkey"),function(i){if(0==i.status){var l={path:"/upload/"+o[n].newPath+i.name,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path,name:i.name},c={id:n};local_api._update("document",c,l,$.cookie("appkey"),function(o){a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),t[a]&&e(t,a),a==t.length&&X(p)})}else a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),t[a]&&e(t,a),a==t.length&&X(p)})}else{var l={path:"/upload/"+o[n].newPath,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path},c={id:n};local_api._update("document",c,l,$.cookie("appkey"),function(o){a++,showTips("ok","正在移动目录和文件"+a+"/"+t.length),a==t.length&&X(p),t[a]&&e(t,a)})}}(a,0)})}function B(e){local_api._list("document",{type:"0|1|2|4"},"","did|id",1,-1,$.cookie("appkey"),function(t){h=t.data,e&&e()})}function X(e){B(),local_api._list("document",{type:"0|1|2|4",u_path:$.cookie("tree_path")+"|^"+$.cookie("tree_path")+","},"","createdAt",1,-1,$.cookie("appkey"),function(a){0==a.status&&a.total&&(t=a.data,e=e||a.data[0].pid,u=c.fileId||u||a.data[0].id,s=s||a.data[0].tree_path,d=d||a.data[0].u_path,c.fileId&&local_api._get("document",{id:c.fileId},"",$.cookie("appkey"),function(e){e.data&&(s=e.data.tree_path,d=e.data.u_path)}),c.fileId=null,$(".file-list").empty(),$("#tree-menu").empty(),U(),P.innerHTML=createFilesHtml(t,u),$(document).on("click",".file-list .file-item",Y),function(e){var t=[];customers=e;for(var a=0;a<e.length;a++)t.push(e[a].name);var o={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(u=a.id,$.cookie("contentId",u),s=a.treePath,d=a.u_path,J(u))}}},n={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(assignFid=a.id,assignTreePath=a.treePath,assignU_path=a.u_path,assignPath=a.path)}}},i=[],l=[];for(a=0;a<e.length;a++)i.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:R[e[a].type],path:e[a].path}),l.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:R[e[a].type],path:e[a].path});if($.fn.zTree.init($("#tree-menu"),o,i),$.fn.zTree.init($("#documentTreeAssign"),n,l),u>=0){var c=$.fn.zTree.getZTreeObj("tree-menu"),r=c.getNodeByParam("id",u,null);r&&(s=r.treePath,d=r.u_path,c.selectNode(r))}}(t),T.innerHTML=createPathNavHtml(t,u),J(u),tools.addEvent(T,"click",Z))})}$("#divDocAudit").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档审核",buttons:{"确定":function(){!function(){createOperate("文档审核");var e={ispass:$("#divDocAudit input[name]:checked").val()},t={tree_path:M.join("|")};local_api._update("document",t,e,$.cookie("appkey"),function(e){console.log(e),showTips("ok","审核成功！"),$("#divDocAudit").dialog("close")})}()},"取消":function(){$("#divDocAudit").dialog("close")}}}),$("#passDoc").on("click",function(){L=[],M=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),$("#divDocAudit").dialog("open")):showTips("err","请选择文件！")}),$("#divDocLock").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档加锁",buttons:{"确定":function(){var e,t;e={islock:parseInt($("#divDocLock input[name]:checked").val())},t={tree_path:M.join("|")},local_api._update("document",t,e,$.cookie("appkey"),function(e){0==e.status?(showTips("ok","加锁成功！"),$("#divDocLock").dialog("close"),J(u)):showTips("err","加锁失败！")})},"取消":function(){$("#divDocLock").dialog("close")}}}),$("#lockDoc").on("click",function(){L=[],M=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),$("#divDocLock").dialog("open")):showTips("err","请选择文档！")}),$("#printCode").on("click",function(e){var t;e.stopPropagation(),createOperate("打印二维码"),L=[],M=[],H=[],ae().length?(ae().forEach(function(e){A.push($(".item",e).data().fileId),M.push("^"+$(".item",e).data().tree_path)}),console.log(A,M),t={tree_path:M.join("|"),type:2,did:">0"},local_api._list("document",t,"did,name","did",1,-1,$.cookie("appkey"),function(e){var t=e.data,a=$("#qrcodePrint")[0]||document.createElement("div");a.id="qrcodePrint";var o='<ul class="qrcodePrint">';t.forEach(function(e){o+='<li><img src="http://h5.bibibaba.cn/pay/wicare/wxpayv3/qrcode.php?data='+e.did+'"><span>'+e.did+"</span></li>"}),o+="</ul>",a.innerHTML=o,$("#qrcodePrint")[0]?($(a).empty(),$(a).append(o)):$("body").append(a);var n=window.document.body.innerHTML,i=$("#qrcodePrint").html();window.document.body.innerHTML=i,function(e){var t,a=!0;!function e(o){$(".qrcodePrint img").each(function(){if(console.log(this.height),0===this.height)return a=!1,!1}),a?(clearTimeout(t),o()):(a=!0,t=setTimeout(function(){e(o)},500))}(function(){window.print(),window.document.body.innerHTML=e,v()})}(n)})):showTips("err","请选择文件！")}),$("#divDocumentAssign").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){F()},"取消":function(){$("#divDocumentAssign").dialog("close")}}}),$(".move").on("click",function(e){ae().length?(console.log(z()),$("#divDocumentAssign").dialog("option","title","移动"),$("#divDocumentAssign").dialog("open")):showTips("err","请选择需要移动的案卷或分类")}),X(p);var Y=function(t){if(console.log(t.currentTarget,"filelist"),!$e){var a=tools.getTarget(t);if(a.className.indexOf("docProo")>-1&&function(t){N=!1,e=t.id.slice("docPro_".length,t.id.length),console.log(e),local_api.getTableColumns("docProp",$.cookie("appkey"),function(t){t.err||(I=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),t.row.forEach(function(e){-1==D.indexOf(e.Field)&&$("#someProp").append('<option value="'+e.Field+'">'+e.Field+"</option>")})),local_api._get("docProp",{fid:e},"",$.cookie("appkey"),function(e){if(console.log(e),0==e.status){if(e.data){for(var t in S=!1,$("#name").val(e.data.name),$("#saveExpireIn").val(e.data.saveExpireIn),$("#createdAt").val(e.data.createdAt),$("#num").val(e.data.num),$("#page").val(e.data.page),$("#did").val(e.data.did),$("#qnum").val(e.data.qnum),$("#lnum").val(e.data.lnum),$("#jnum").val(e.data.jnum),$("#cnum").val(e.data.cnum),$("#ce").val(e.data.ce),$("#newPropLi").empty(),e.data)if(-1==D.indexOf(t)&&e.data[t]){var a=document.createElement("li");a.style.marginTop="10px",a.dataset=t;var o=' \n                                        <label class="ellipsis" title="'+t+'">'+t+'</label>\n                                        <input value="'+e.data[t]+'" class="form-control" style="width:60%"/>\n                                    ';a.innerHTML=o,$("#newPropLi").append(a)}}else S=!0,$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0);$("#divDocPro").dialog("open")}})})}(t.target),a.className.indexOf("openProo")>-1&&function(e){createOperate("打开密集柜");var t=e.id.slice("openProo_".length,e.id.length);local_api._get("docProp",{fid:t},"",$.cookie("appkey"),function(e){if(e.data){var t=parseInt(e.data.qnum||0),a=parseInt(e.data.lnum||0),o=parseInt(e.data.jnum||0),n=parseInt(e.data.cnum||0),i=parseInt(e.data.ce||0),l=parseInt(e.data.bnum||1);if(t>0&&a>0&&o>0&&n>0&&i>=0){var c={qu:t,lie:a,jie:o,ceng:n,ce:i,bh:l,name:e.data.did,status:1};local_api._delete("playApp",{id:">0"},$.cookie("appkey"),function(e){local_api._create("playApp",c,$.cookie("appkey"),function(e){var t=e.id;q&&clearInterval(q),q=setInterval(function(){local_api._get("playApp",{id:t},"",$.cookie("appkey"),function(e){1!=e.data.status&&(clearInterval(q),2==e.data.status?showTips("ok","打开成功！"):3==e.data.status?showTips("err","密集柜连接失败，请检查是否已连接！"):showTips("err","打开失败，请重新打开！"))})},1e3)})})}else showTips("err","无位置信息，无法打开密集柜！")}else showTips("err","无位置信息，无法打开密集柜！")}),console.log(t)}(t.target),a.className.indexOf("folder")>-1||function(e){var t=parseInt(e.target.dataset.type);if([0,1,2,4].indexOf(t)>-1)return!0;if("file-title"==e.target.className){var a=parseInt(e.target.parentNode.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}if("file-title-box"==e.target.className){a=parseInt(e.target.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}return!1}(t)){if(r=$(".file-list").scrollTop(),tools.parents(a,".item")){var o=(a=tools.parents(a,".item")).dataset.fileId;u=o,$.cookie("contentId",u);var n=$.fn.zTree.getZTreeObj("tree-menu"),i=n.getNodeByParam("id",u,null);i&&(s=i.treePath,d=i.u_path,n.selectNode(i)),J(o)}}else{console.log($(".item",t.currentTarget).data());var l=$(".item",t.currentTarget).data(),c=l.filepath,p=c.slice(c.lastIndexOf("."),c.length);if(3==l.type&&".pdf"==p&&(f="/pdfView?fileid="+l.fileId,window.open(f,"_blank")),3==l.type&&/\.(?:xls|xlsx|doc|docx)$/.test(p)){console.log(l);var f="/upload/"+g(l.tree_path)+$(".item .file-title",t.currentTarget).text();window.open(f,"_self")}}}},Z=function(e){var t=tools.getTarget(e);if(tools.parents(t,"a")){var a=t.dataset.fileId;u=a,$.cookie("contentId",u);var o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("id",u,null);n&&(s=n.treePath,d=n.u_path,o.selectNode(n)),J(a)}},U=function(){$(document).off("click",".file-list .file-item",Y),tools.removeEvent(T,"click",Z)},R={0:"./img/icon-file-s.svg",1:"./img/icon-file-s.svg",2:"./img/icon-file-s1.svg",4:"./img/icon-file-s2.svg"};function J(e){r&&setTimeout(function(){$(".file-list")[0].scrollTop=r},1e3),k=[],t.forEach(function(t){t.id==e&&(1==t.type||0==t.type?($("#folder1").show(),$("#folder2").show(),$("#folder3").hide()):($("#folder1").hide(),$("#folder2").hide(),$("#folder3").show()),k.push(t))});var a={pid:e,u_path:"^"+d};-1==roleArr.indexOf("访问加锁文档")&&(a.islock="<>2"),local_api._list("document",a,"",m,1,-1,$.cookie("appkey"),function(a){$(".file-list").empty();var o=!!a.total;k=k.concat(a.data),console.log(o),o?(E.style.display="none",P.innerHTML=createFilesHtml(k,e)):(E.style.display="block",P.innerHTML=""),T.innerHTML=createPathNavHtml(t,e),K=tools.$(".file-item",P),tools.each(K,function(e,t){te(e)}),tools.removeClass(Q,"checked"),u=e,$.cookie("contentId",u)})}tools.addEvent(tools.$(".mod-action-wrap")[1],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(W(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",V)):void 0});var V=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;W(),tools.removeEvent(document,"mouseover",V)}};function W(){tools.$("#btn-change .action-item-con").forEach(function(e){e.style.background="#fff"}),tools.$("#btn-change .act-txt").forEach(function(e){e.style.display="none"})}for(var G=0;G<tools.$(".mod-action-wrap")[1].children.length;G++)tools.addEvent(tools.$(".mod-action-wrap")[1].children[G],"click",function(e){console.log(tools.hasClass(this,"act")),this==tools.$(".mod-action-wrap")[1].children[0]?tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[1].className="action-item",tools.addClass(tools.$(".file-list")[0],"f_detail")):tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[0].className="action-item",tools.removeClass(tools.$(".file-list")[0],"f_detail"))});var K=tools.$(".file-item",P),Q=tools.$(".cheched-all")[0],ee=tools.$(".checkbox",P);function te(e){var t=tools.$(".checkbox",e)[0];tools.addEvent(e,"mouseenter",function(){tools.addClass(this,"file-checked")}),tools.addEvent(e,"mouseleave",function(){tools.hasClass(t,"checked")||tools.removeClass(this,"file-checked")}),tools.addEvent(t,"click",function(e){console.log(e,"thischeck"),ee=tools.$(".checkbox",P),tools.toggleClass(this,"checked")?ae().length==ee.length&&tools.addClass(Q,"checked"):tools.removeClass(Q,"checked"),tools.stopPropagation(e)})}function ae(){var e=[];return tools.each(ee,function(t,a){tools.hasClass(t,"checked")&&e.push(K[a])}),e}tools.each(K,function(e,t){te(e)}),console.log($(".file-list .checkbox")),tools.addEvent(Q,"click",function(e){K=tools.$(".file-item",P),ee=tools.$(".checkbox",P),tools.toggleClass(this,"checked")?tools.each(K,function(e,t){tools.addClass(e,"file-checked"),tools.addClass(ee[t],"checked")}):tools.each(K,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked")})}),tools.addEvent(tools.$(".mod-action-wrap")[0],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(ne(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",oe)):void 0});var oe=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;ne(),tools.removeEvent(document,"mouseover",oe)}};function ne(){tools.$(".mod-nav .action-item-con").forEach(function(e){e.style.background="#fff"}),tools.$(".mod-nav .act-txt").forEach(function(e){e.style.display="none"})}var ie=null,le=null,ce=0;ce=0;tools.addEvent(tools.$(".main")[0],"mousedown",function(e){var t=tools.getTarget(e);tools.parents(t,".nav-a")||(ce=e.clientX,disY=e.clientY,tools.addEvent(document,"mousemove",de),tools.addEvent(document,"mouseup",pe),e.preventDefault())});var se=!1;function re(e){if(console.log(e.target),e.target,!le){le=document.createElement("div"),document.body.appendChild(le),$(le).css({position:"fixed",width:"150px",height:"40px"});var t='<div class="selectboxMoveone">\n                        <div>\n                            <span></span>\n                            <span class="ellipsis">'+$(".file-title",ae()[0]).text()+'</span>\n                        </div>\n                        <span class="moveleng">'+ae().length+"</span>\n                    </div>\n                    "+(ae().length>1?'<div class="selectboxMovemore"></div>':"")+"\n                    ";$(le).append(t)}$(le).css({top:e.clientY+2,left:e.clientX+2})}function de(e){function t(){Math.abs(e.clientX-ce)>20||Math.abs(e.clientY-disY)>20?(ie||(ie=document.createElement("div"),document.body.appendChild(ie),ie.className="select-box"),console.log(ie,"hi"),ie.style.display="block",ie.style.width=Math.abs(e.clientX-ce)+"px",ie.style.height=Math.abs(e.clientY-disY)+"px",ie.style.left=Math.min(e.clientX+2,ce-2)+"px",ie.style.top=Math.min(e.clientY+2,disY-2)+"px",tools.each(K,function(e,t){tools.collisionRect(ie,e)?(tools.addClass(e,"file-checked"),tools.addClass(ee[t],"checked")):(tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked"))}),ae().length==ee.length?tools.addClass(Q,"checked"):tools.removeClass(Q,"checked")):ie&&(ie.style.display="none")}le?re(e):(se?ae().indexOf(e.target.parentNode)>-1?re(e):function e(t,a,o){o=o;var n=$(t).parent()[0];"BODY"==n.nodeName?o(!1):n.className.indexOf(a)>-1?o(n):e(n,a,o)}(e.target,"file-item",function(a){console.log(a,"paen"),a&&ae().indexOf(a)>-1?re(e):(se=!1,t())}):t(),K=tools.$(".file-item",P),ee=tools.$(".checkbox",P))}function pe(e){if(tools.removeEvent(document,"mousemove",de),tools.removeEvent(document,"mouseup",pe),ie&&(ie.style.display="none"),se=!se,le)se=!0,$(le).remove(),le=null,function(e){if(e.target.id.indexOf("tree-menu")>-1){var t=e.target.id.split("_"),a=t[0]+"_"+t[1],o=$.fn.zTree.getZTreeObj("tree-menu").getNodeByParam("tId",a,null);o&&(assignFid=o.id,assignTreePath=o.treePath,assignU_path=o.u_path,assignPath=o.path,F())}}(e);else if(console.log(f),ie)$(ie).remove(),ie=null;else{var t=e.target.parentNode.className;"nav"!=t&&"file-show"!=t&&"content clearfix"!=t||(tools.each(K,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(ee[t],"checked")}),tools.removeClass(Q,"checked"),se=!1)}}var ue,fe=tools.$(".create")[0];function he(e){E.style.display="none";var t=P.firstElementChild,a=createFileElement({title:"",id:(new Date).getTime(),type:e,name:""});P.insertBefore(a,t);var o=$(".file-title",a);o.css("display","none"),o.parent().append('<span class="file-edtor"> <input type="text" value="" class="edtor" autofocus="autofocus"></span>');var n=$(".edtor",a);n.focus(),$(".file-edtor",a).on("mousedown",function(e){e.stopPropagation()}),$(n).on("keyup",function(e){13==e.keyCode&&me()}),fe.isCreateFile=!0,tools.addEvent(document,"mousedown",me)}function me(e){if(createOperate("新建"),fe.isCreateFile){var t=P.firstElementChild,a=tools.$(".edtor",t)[0].value.trim();if(""===a)P.removeChild(t),""===P.innerHTML&&(E.style.display="block");else{var o=tools.$(".file-title",t)[0],n=$(".file-edtor",t);console.log(t),o.style.display="block",o.innerHTML=a,n.remove();var i={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,name:a,type:ue,u_path:d};local_api._create("document",i,$.cookie("appkey"),function(e){var t=s+","+e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){X(p),2==ue?showTips("ok","新建案卷成功!"):1==ue?showTips("ok","新建分类成功!"):4==ue&&showTips("ok","新建组成功!")})})}fe.isCreateFile=!1,tools.removeEvent(document,"mousedown",me)}}$(".create").on("click",function(){$(".create_file").toggleClass("act")}),$(document).on("mousedown",function(){$(".create_file").hasClass("act")&&$(".create_file").toggleClass("act")}),$("#folder1").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=1,he(1)}),$("#folder2").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=2,he(2)}),$("#folder3").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ue=4,he(4)});var ve=tools.$(".rename")[0],$e=!1;tools.addEvent(ve,"mouseup",function(){if(K=tools.$(".file-item",P),ee=tools.$(".checkbox",P),createOperate("重命名"),ae().length)if(ae().length>1)showTips("err","只能对单个文件重命名！");else{var e=function(t){if(!t||(t.stopPropagation(),t.preventDefault(),t.target.parentNode!=s)){var l=c.val().trim();if(""==l)showTips("err","请输入文件名！");else{var r,d,u=g(o);3==n?(r=u+i,d=u+l):(r=u,d=u.slice(0,u.lastIndexOf(i))+l),console.log(u);var f={type:1,oldPath:r,newPath:d};local_api._rename(f,$.cookie("appkey"),function(e){console.log(e),setTimeout(function(){return $e=!1},2e3),0==e.status?local_api._update("document",{id:a},{name:l},$.cookie("appkey"),function(e){0==e.status&&(showTips("ok","重命名成功"),X(p))}):(showTips("err",e.message),X(p))})}tools.removeEvent(document,"mousedown",e)}},t=$(".file-checked .file-title"),a=$(".file-checked .item").data().fileId,o=$(".file-checked .item").data().tree_path,n=$(".file-checked .item").data().type;if(console.log($(".file-checked .item").data()),0!=$(".file-checked .item").data().type){$e=!0;var i=t.attr("title"),l='<span class="file-edtor"> <input type="text" value="'+i+'" class="edtor"></span>';t.css("display","none"),t.parent().append(l);var c=$(".file-checked .edtor"),s=$(".file-checked .file-edtor")[0];c.select(),$(".file-checked .file-edtor").on("mousedown",function(e){e.stopPropagation()}),c.on("keypress",function(t){13==t.keyCode&&e()}),tools.addEvent(document,"mousedown",e)}else showTips("err","无法对客户文件夹进行重命名!")}else showTips("err","请选择文件！")}),tools.addEvent(tools.$(".nav-box")[0],"click",function(e){console.log(tools.getTarget(e)),console.log(tools.getTarget(e).parentNode),tools.hasClass(tools.getTarget(e).parentNode,"nav-list")&&(tools.each(tools.$(".nav-list.nav-current"),function(e){console.log(e.className),tools.removeClass(e,"nav-current")}),tools.addClass(tools.getTarget(e).parentNode,"nav-current")),console.log(tools.hasClass(tools.getTarget(e).parentNode,"nav-list"))}),tools.addEvent(tools.$("#search")[0],"focus",function(){var e=tools.$("#_search_bar")[0];tools.addClass(e,"focus")}),tools.addEvent(tools.$("#search")[0],"blur",function(){var e=tools.$("#_search_bar")[0];setTimeout(function(){tools.removeClass(e,"focus")},200)}),$("#search").on("keypress",function(e){createOperate("文件检索"),13==e.keyCode&&""!=e.target.value.trim()&&(location.href="/hightSearch?query="+e.target.value.trim())}),$(".upload").on("click",function(e){e.stopPropagation(),_e()}),$(".upload-file").on("click",function(e){e.stopPropagation();var t=e.target.parentNode,a=e.target.parentNode.parentNode,o=$(".upload-file").children().children();t!=o[0]&&a!=o[0]||_e()});var ge={"01":"01_履历材料","02":"02_自传材料","03":"03_鉴定、考核、考察、审计材料","04":"04_学历、学位、专业技术和培训等材料","05":"05_政审材料","06":"06_参加党团的材料","07":"07_表彰奖励材料","08":"08_涉纪涉法处分材料","09":"09_工资、任免、出国、代表大会等材料",10:"10_其他供参考材料"};function _e(){createOperate("文件上传");var e=document.createElement("input");e.type="file",e.multiple="multiple",$(e).change(function(e){console.log(this.files);var t=this.files,c=o.length+0;$(".mod-tasks .tasks-header").removeClass("result-succt").addClass("tasking-nor");var r=s.split(",");function f(e){$(e).on("click",function(e){console.log(e);var t=e.currentTarget.dataset.file_id;console.log(t),$(e.currentTarget).hasClass("waiting")&&$(e.target).hasClass("btn-icon")&&(l.push(parseInt(t)),m(3,t)),$(e.currentTarget).hasClass("cancel")&&$(e.target).hasClass("btn-icon")})}function m(e,t){var n=o[t],l=uploadHtml(e,n,t);f(l),$(a[t],i).replaceWith(l),a.splice(t,1,l)}function v(e,t,o,n){var i=new FormData;i.append(e.last_name,o);var l="/upload?path="+encodeURI(g(e.tree_path));http({type:"POST",url:l,data:i,onProgress:function(e){console.log(e.percent),$(".task-txt-status",a[c]).text(e.percent.toFixed(2)+"%")},onSuccess:function(a){console.log(a),a.fmd5=t,0==a.status?function(e,t,a){var o={pid:t.id,size:e.file.size,type:3,name:e.file.filename};t.hb?(console.log(t.hb),local_api._rename(t.hb.rename,$.cookie("appkey"),function(o){0==o.status?local_api._fsCombind(t.hb.combind,$.cookie("appkey"),function(o){if(0==o.status){var n={id:t.hb.id,tree_path:t.hb.tree_path},i=parseInt(t.hb.size)+parseInt(e.file.size);local_api._update("document",{id:t.hb.id},{size:i},$.cookie("appkey"),function(e){a(n)})}else local_api._update("document",{id:t.hb.id},{name:t.hb.newname},$.cookie("appkey"),function(e){a({})})}):a({})})):local_api._get("document",o,"",$.cookie("appkey"),function(o){if(0!=o.status||o.data){if(0==o.status&&o.data){var n={id:o.data.id,tree_path:o.data.tree_path};a(n)}}else{var i=e.file.mimetype.indexOf("image")>-1?"png":"txt",l=t.tree_path.split(",")[t.tree_path.split(",").length-1];l==t.id&&(l=t.id);var c={size:e.file.size,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:l,type:3,filetype:i,name:e.file.filename,path:"/upload/"+g(t.tree_path)+e.file.filename,f_md5:e.fmd5,u_path:d,ispass:1,islock:1};local_api._create("document",c,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n={id:e.id,tree_path:o};local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){a(n)})})}})}(a,e,function(e){n(e)}):n(a)},onError:function(e){n(res)}})}dataControl.getParents(h,r[r.length-1]).reverse().forEach(function(e){e.name+"/"}),Array.prototype.forEach.call(t,function(e,t){console.log(e),$(".mod-tasks").show();var n=uploadHtml(0,e,c+t);f(n),a.push(n),o.push(e),i.append(n)}),function e(){var t=o[c];if(l.indexOf(c)>-1)return c++,void e();if(o.length==c)$(".mod-tasks .tasks-header").removeClass("tasking-nor").addClass("result-succ"),$(".mod-tasks .summary-wrapper .txt").text("任务已完成  "+n+"项任务失败"),$(".title-wrapper h2.title").text("任务已完成  "+n+"项任务失败");else{var i=(c/o.length).toFixed(1);$(".mod-tasks .summary-wrapper .before").css("transform","scaleX("+i+")"),$(".mod-tasks .summary-wrapper .txt").text(c+"/"+o.length+"项任务进行中  "+n+"项任务失败"),$(".title-wrapper h2.title").text(c+"/"+o.length+"项任务进行中  "+n+"项任务失败")}t&&function(e,t,a){get_filemd5sum(e,function(t){!function(e,t){var a=e.indexOf("【"),o=e.indexOf("】");if(a>-1&&o>0){var n=e.slice(a+1,o).trim(),i=e.slice(o+1,e.length).trim(),l=n.split("_");l=l.map(function(e){return e.trim()});var c=s.split(",")[s.split(",").length-1];c==u&&(c=u);var r={did:l[0],name:l[0]+l[1],tree_path:"^"+s,pid:c};local_api._get("document",r,"",$.cookie("appkey"),function(e){if(0==e.status&&e.data)if(l[2]){var a={name:l[2],tree_path:"^"+e.data.tree_path,pid:e.data.id};local_api._get("document",a,"",$.cookie("appkey"),function(a){if(0==a.status&&a.data)t(Object.assign(a.data,{last_name:i}));else if(0==a.status){var o={name:l[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:e.data.id,u_path:d};local_api._create("document",o,$.cookie("appkey"),function(a){var o=e.data.tree_path+","+a.id,n={id:a.id,tree_path:o,last_name:i};local_api._update("document",{id:a.id},{tree_path:o},$.cookie("appkey"),function(e){t(n)})})}else t({status:-1})})}else t(Object.assign(e.data,{last_name:i}));else if(1==l.length){var o={name:l[0],did:l[0],type:2,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:c,u_path:d};local_api._create("document",o,$.cookie("appkey"),function(e){var a=s+","+e.id,o={id:e.id,tree_path:a,last_name:i};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(a){var n={fid:e.id,name:l[0],did:l[0],u_path:d};local_api._create("docProp",n,$.cookie("appkey"),function(e){t(o)})})})}else t({status:-1})})}else{var p=e.split("_");if(p.length>1){var f=h.filter(function(e){return e.did==p[0]});if(f.length){var m={id:f[0].id,tree_path:f[0].tree_path,last_name:ge[p[1].split(".")[0]]+".pdf"};t(m)}else t({status:-1})}else{t(m={id:u,tree_path:s,last_name:e})}}}(e.name,function(o){-1!=o.status?B(function(){var n="",i=o.last_name,l="",c=0;i.lastIndexOf(".")>-1?(n=i.slice(0,i.lastIndexOf(".")),l=i.slice(i.lastIndexOf("."))):(n=i,l="");var s=t;if(-1!=s){var r=function(){c++;var t={name:i,tree_path:"^"+o.tree_path,type:3};local_api._get("document",t,"",$.cookie("appkey"),function(t){if(0==t.status&&t.data){if(t.data.f_md5==s)a(t.data);else if(i=n+c+l,r(),".pdf"==l){var d=g(t.data.tree_path)+t.data.name,p=g(t.data.tree_path)+n+"99"+l,u=g(t.data.tree_path)+i;o.hb={rename:{type:1,oldPath:d,newPath:p},combind:{input:{0:p,1:u},output:d},id:t.data.id,tree_path:t.data.tree_path,name:t.data.name,newname:n+"99"+l,size:t.data.size}}}else 0!=t.status||t.data||(o.last_name=i,v(o,s,e,a))})};r()}}):a({})})})}(t,0,function(t){t.id?(m(1,c),$(".task-txt-status",a[c]).text("100%")):(n++,m(2,c)),c++,t.name||X(p),e()})}()}),e.click()}function ke(){m.split("|").forEach(function(e){var t=e;e.indexOf("-")>-1&&(t=e.slice(1,e.length));var a,o="__"+t;$("#"+o).prop("checked",!0),a=e.indexOf("-")>-1?$("label",$("#"+o).parent()).attr("value")+"↑":$("label",$("#"+o).parent()).attr("value")+"↓",$("label",$("#"+o).parent()).text(a)});var e=$("#divDocSort input:not(:checked) ").not('input[name="sort"]'),t=$("#divDocSort input:radio:checked").val();e.each(function(e,a){var o;2==t?o=$("label",$(a).parent()).attr("value")+"↓":1==t&&(o=$("label",$(a).parent()).attr("value")+"↑"),$("label",$(a).parent()).text(o)})}$(".delete").on("click",function(e){console.log(ae());var t=ae();if(ae().length){var a=[],o=[],n={},i=[],l=[];t.forEach(function(e){var t=$(".item",e).data().type,c={};if(0!=t?(a.push("^"+$(".item",e).data().tree_path),3==t?(c.tree_path="^"+$(".item",e).data().tree_path,c.path=g($(".item",e).data().tree_path)+$(".item .file-title",e).text()):(c.tree_path="^"+$(".item",e).data().tree_path,c.path=g($(".item",e).data().tree_path)),l.push(c)):o.push("^"+$(".item",e).data().tree_path),!n[t]){n[t]=1;var s=1==t?"分类":2==t?"案卷":3==t?"文件":"";i.push(s)}}),createOperate("文件删除"),console.log(l),o.length>0&&showTips("err","无法对客户文件夹进行删除操作");var c="确定要删除"+(t.length>1?"这些":"这个")+i.join("/")+"？";a.length&&confirm(c)&&l.forEach(function(e,t){local_api._fsDelete({curPath:e.path},$.cookie("appkey"),function(a){0==a.status&&local_api._delete("document",{tree_path:e.tree_path},$.cookie("appkey"),function(e){t==l.length-1&&(X(p),showTips("ok","删除"+i.join("/")+"成功!"))})})})}else showTips("err","请选择文件或档案！")}),$(".logout").on("mousedown",function(e){e.stopPropagation(),location.href="/logout"}),$("#showList").click(function(){$(".mod-tasks").toggleClass("expand")}),$("#hideList").click(function(){$(".mod-tasks").hide(),a=[],o=[],n=0,i.empty(),fileIndex=0}),$("#divCombind").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){!function(){var e={handle_json:{input:{},output:""},update:{path:"",name:"",size:""},query:{id:""},delete_j:{id:""}},t=[],a=ae();if(a.length?a.forEach(function(e){var a=$(".item",e).data();a.name=$(".item .file-title",e).text(),a.size=backFileSize($(".item ul>li:nth-child(1)",e).text()),t.push(a)}):showTips("err","请选择pdf文件进行合并！"),t.length){var o=0,n=[];t.forEach(function(t,a){o+=t.size,e.handle_json.input[a]=g(t.tree_path)+t.name,0==a?(e.query.id=t.fileId,e.update.name=$("#renameCombind").val().trim()+".pdf",e.update.path="/upload/"+g(t.tree_path)+$("#renameCombind").val().trim()+".pdf",e.handle_json.output=g(t.tree_path)+$("#renameCombind").val().trim()+".pdf"):n.push(t.fileId)}),e.delete_j.id=n.join("|"),e.update.size=o,createOperate("合并文件"),confirm("确定合并已选择的文件")?local_api._fsCombind(e.handle_json,$.cookie("appkey"),function(t){0==t.status?local_api._update("document",e.query,e.update,$.cookie("appkey"),function(t){local_api._delete("document",e.delete_j,$.cookie("appkey"),function(e){showTips("ok","合并成功!"),$("#divCombind").dialog("close"),J(u)})}):(showTips("err","合并失败!"),$("#divCombind").dialog("close"))}):$("#divCombind").dialog("close")}else showTips("err","请选择pdf文件进行合并！")}()},"取消":function(){$("#divCombind").dialog("close")}}}),$("#combind").on("click",function(){$("#divCombind").dialog("open")}),$("#divDocSort").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){X(p),$("#divDocSort").dialog("close")},"取消":function(){$("#divDocSort").dialog("close")}}}),$("#sort").on("click",function(){ke(),$("#divDocSort").dialog("open")}),$("#divDocSort input").change(function(){var e=m.split("|"),t=$("#divDocSort input:radio:checked").val();if("sort"!==$(this).attr("name"))if($(this).attr("checked"))2==t?e.push($(this).val()):1==t&&e.push("-"+$(this).val());else{var a=e.indexOf($(this).val())>-1?e.indexOf($(this).val()):e.indexOf("-"+$(this).val());console.log(a),e.splice(a,1)}m=e.join("|"),console.log(e,m,"dd"),ke()}),$("#divDocImport").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择分类",buttons:{"确定":function(){console.log($("#DocImport").val());var e=$("#DocImport").val(),t=document.createElement("input");t.type="file",$(t).change(function(t){var a=$(this)[0].files;1==e?ye(a):2==e&&we(a),$("#divDocImport").dialog("close")}),t.click()},"取消":function(){$("#divDocImport").dialog("close")}}}),$("#export").click(function(){$("#divDocImport").dialog("open")}),$("#exportPorp").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){$(this)[0].files}),e.click()});var ye=function(e){createOperate("导入台账");var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}),o=a.SheetNames,n={},i=h.filter(function(e){return 1==e.type&&e.tree_path.indexOf(s)>-1});for(var l in o.forEach(function(e,t){i.forEach(function(t){e.trim()==t.name&&(console.log(t),n[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),n)c(l,n[l].id,n[l].tree_path);function c(e,t,o){var n=a.Sheets[e],i=_(n["!ref"]),l=[];for(var c in n){var s=[];c.split("").forEach(function(e){/^[A-Z]+$/.test(e)&&s.push(e)}),s.join("")&&-1==l.indexOf(s.join(""))&&l.push(s.join(""))}for(var r=[],u=[],f=["createdAt","saveExpireIn","page","num","did","name","具体地址","位置","社区单位编号","是否建档","经营状态"],h=5;h<i;h++){var m={u_path:d},v={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t,type:2,u_path:d};l.forEach(function(e){if(n[e+h]){var t=n[e+3]?n[e+3].v:n[e+4]?n[e+4].v:"";switch(t){case"建档时间":t="createdAt";break;case"保管期限":t="saveExpireIn";break;case"页数":t="page";break;case"文书份数":t="num";break;case"企业名称":t="name";break;case"档号":case"档案编号":t="did"}if("name"==t&&(v.name=n[e+h].v),"did"==t&&(v.did=n[e+h].v),f.indexOf(t)>-1)if("位置"==t){var a=n[e+h].v.split("_");6==a.length&&(m.qnum=a[0],m.lnum=a[1],m.ce=a[2],m.jnum=a[3],m.cnum=a[4],m.bnum=a[5])}else m[t]=n[e+h].v}}),m.name&&u.push(v),m.name&&r.push(m)}console.log(u,r);var g=0,k=function(){var t=u[g],a=r[g];if(g++,t){var n=Object.assign({},t);delete n.createdAt,n.name=n.did+n.name,local_api._get("document",n,"",$.cookie("appkey"),function(e){console.log(n,e.data,!!e.data),0!=e.status||e.data?k():(t.name=t.did+t.name,t.ispass=1,t.islock=1,console.log(t,a,"ddf______________"),k(),local_api._create("document",t,$.cookie("appkey"),function(e){var t=o+","+e.id,n=e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){var t=a;t.fid=n,local_api._create("docProp",t,$.cookie("appkey"),function(e){k()})})}))})}else X(p),showTips("ok","导入"+e+"成功")};return k(),{createDoc:u,createArr:r}}console.log(n,"")}},we=function(e){var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}),o=a.SheetNames,n={},i=h.filter(function(e){return 1==e.type&&e.tree_path.indexOf(s)>-1});for(var l in o.forEach(function(e,t){i.forEach(function(t){e.trim()==t.name&&(console.log(t),n[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),n)c(l,n[l].id,n[l].tree_path);function c(e,t,o){var n=a.Sheets[e],i=_(n["!ref"]),l=[];for(var c in n){var s=[];c.split("").forEach(function(e){/^[A-Z]+$/.test(e)&&s.push(e)}),s.join("")&&-1==l.indexOf(s.join(""))&&l.push(s.join(""))}var r=[],u=[];console.log(i);for(var f=2;f<i;f++){var m={u_path:d},v={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t,type:2,u_path:d};l.forEach(function(e){if(n[e+f]){var t=n[e+1]?n[e+1].v:n[e+2]?n[e+2].v:"";switch(t){case"类别":var a=h.filter(function(t){return t.name==n[e+f].v});console.log(a,"dd"),a.length>0&&(v.pid=a[0].id,v.tree_path=a[0].tree_path);break;case"姓名":t="name";break;case"档案号":t="did"}m[t]=n[e+f].v,"name"==t&&(v.name=n[e+f].v),"did"==t&&(v.did=n[e+f].v)}}),m.name&&u.push(v),delete m["序号"],delete m["类别"],m.name&&r.push(m)}console.log(u,r);var g=0,k=function(){var t=u[g],a=r[g];if(g++,t){var o=Object.assign({},t);delete o.createdAt,o.name=o.name,local_api._get("document",o,"",$.cookie("appkey"),function(e){console.log(o,e.data,!!e.data),0!=e.status||e.data?k():(t.name=t.name,t.ispass=1,t.islock=1,console.log(t,a,"ddf______________"),local_api._create("document",t,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n=e.id;local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){var t=a;console.log(e,"up"),t.fid=n,local_api._create("docProp",t,$.cookie("appkey"),function(e){console.log(e,"docP"),k()})})}))})}else X(p),showTips("ok","导入"+e+"成功")};k()}console.log(n,"")}}}(),window.doc_path=g}});