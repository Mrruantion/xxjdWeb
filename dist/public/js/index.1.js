!function(e){var t={};function a(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=t,a.d=function(e,t,o){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},a.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=12)}({12:function(e,t){var a,o,n=[],i=[],l=$(".task-list-cont"),s=[],c=getSearch(),d="",r=$.cookie("tree_path"),p=0,u=$.cookie("contentId"),m=[];function h(){r=$.cookie("tree_path");var e,t,v,g=tools.$(".header")[0],_=tools.$(".weiyun-content")[0],k=g.offsetHeight,y=tools.$(".content")[0],w=tools.$(".file-list")[0];console.log(data);tools.$(".tree-menu")[0];var P=tools.$(".path-nav")[0],b=tools.$(".g-empty")[0];$.cookie("uid");function x(){var e=document.documentElement.clientHeight;_.style.height=e-k+"px",y&&(y.style.height=e-k-62+"px"),w&&(w.style.height=e-k-93+"px")}function T(){var e="";return[1,2,3,4,5,6,7,8,9].forEach(t=>{e+=`<option value="${t}">${t}</option>`}),e}x(),window.onresize=x,$("#qnum").empty().append(T()),$("#lnum").empty().append(T()),$("#jnum").empty().append(T()),$("#cnum").empty().append(T());var C=[],E=["id","fid","u_path","did","name","saveExpireIn","createdAt","num","page","qnum","lnum","jnum","cnum","ce","bnum","pname","lname"];function O(e){var t=document.createElement("li");t.style.marginTop="10px",t.dataset=e;var a=` \n            <label class="ellipsis" title="${e}">${e}</label>\n            <input value="" class="form-control" style="width:50%"/>\n            <button class="btn btn-primary newBtn" style="">删除</button>\n        `;t.innerHTML=a,$("#newPropLi").append(t),console.log($(t)),$("button",t).on("click",function(t){console.log(e),C.splice(C.indexOf(e),1),$(t.target).parent().remove()})}$("#divDocPro").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"保存":function(){I?function(){if(console.log(D),!D.length)return void showTips("err","该档案下没有案卷可设置");for(var e=[],t={u_path:r,name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),did:$("#did").val(),num:$("#num").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}D.forEach(a=>{var n=Object.assign({},t,o);n.fid=a,e.push(n)}),confirm("批量设置属性会覆盖案卷原有属性，是否批量设置属性")&&local_api._delete("docProp",{fid:D.join("|")},$.cookie("appkey"),function(t){console.log(t),local_api._createBatch("docProp",{data:JSON.stringify({data:e})},$.cookie("appkey"),function(e){createOperate("批量设置案卷属性"),$("#divDocPro").dialog("option","title","属性"),$("#divDocPro").dialog("close")})});console.log(e)}():function(){if(createOperate("单个设置属性"),M){for(var t={name:$("#name").val(),fid:e,u_path:r,saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(t,o),console.log(t),local_api._create("docProp",t,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}else{for(var l={name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},s={fid:e},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(l,o),console.log(l),local_api._update("docProp",s,l,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}}()},"取消":function(){$("#divDocPro").dialog("close")}}}),$("#selectProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择自定义属性",buttons:{"确定":function(){$("#selectProp").dialog("close")}}}),$("#newCustomProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"添加新属性",buttons:{"确定":function(){var e;e=$("#newPropname").val(),local_api._createColumn("docProp",{name:e,size:50},"",function(t){createOperate("添加自定义属性"),t.err?showTips("err","添加属性失败"):(O(e),C.push(e),$("#someProp").append(`<option value="${e}">${e}</option>`),$("#newCustomProp").dialog("close"))})},"取消":function(){$("#newCustomProp").dialog("close")}}}),$("#someProp").on("change",function(e){console.log(this.value),0!=this.value&&(-1==C.indexOf(this.value)?(C.push(this.value),O(this.value)):showTips("err","该属性已存在"))}),$("#newProp").click(function(){$("#newCustomProp").dialog("open")}),$("#addCustom").click(function(){$("#selectProp").dialog("open")});var I=!1,N=[],j=[],A=[],D=[];$("#someProo").on("click",function(){I=!0,N=[],j=[],A=[],D=[],console.log(K()),K().length?(K().forEach(e=>{3!=$(".item",e).data().type&&(N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path),A.push($(".item .file-title",e).text()))}),console.log(N,j,A),local_api.getTableColumns("docProp",$.cookie("appkey"),function(e){e.err||(C=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),e.row.forEach(e=>{-1==E.indexOf(e.Field)&&$("#someProp").append(`<option value="${e.Field}">${e.Field}</option>`)})),local_api._list("document",{tree_path:j.join("|"),type:2},"","",1,-1,$.cookie("appkey"),function(e){$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0),$("#divDocPro").dialog("option","title","批量设置属性"),$("#divDocPro").dialog("open"),e.data.forEach(e=>{D.push(e.id)})})})):showTips("err","请选择文件！")});var M=!1;function H(){for(var e=K(),t={tree_path:[],id:[]},a=0;a<e.length;a++)t.tree_path.push("^"+$(".item",e[a]).data().tree_path),t.id.push($(".item",e[a]).data().fileId);return t}function q(){createOperate("移动");var e=H().tree_path,t=H().id;console.log(assignFid,assignTreePath,assignU_path);var a=[];local_api._list("document",{tree_path:e.join("|")},"","",1,-1,$.cookie("appkey"),function(e){e.data.forEach(o=>{var n={};if(n[o.id]={},t.indexOf(o.id)>-1){n[o.id].pid=assignFid;var i=o.tree_path.indexOf(o.id),l=o.tree_path.length,s=assignTreePath+","+o.tree_path.slice(i,l);n[o.id].oldtree_path=o.tree_path,n[o.id].tree_path=s,n[o.id].olePath=f(o.tree_path),n[o.id].newPath=f(s),n[o.id].u_path=assignU_path,n[o.id].name=o.name,n[o.id].type=o.type,a.push(n),function t(o,n){var i=dataControl.getChildById(e.data,o);i.length&&i.forEach(e=>{var i={};i[e.id]={},i[e.id].pid=o,i[e.id].oldtree_path=e.tree_path;var l=n+","+e.id;i[e.id].tree_path=l,i[e.id].olePath=f(e.tree_path),i[e.id].newPath=f(l),i[e.id].u_path=assignU_path,i[e.id].name=e.name,i[e.id].type=e.type,a.push(i),t(e.id,l)})}(o.id,s)}}),console.log(a);$("#divDocumentAssign").dialog("close"),function e(t,a){console.log(t[a]);var o=t[a];for(var n in o)if(3==o[n].type){var i={oldPath:o[n].olePath,newPath:o[n].newPath,name:o[n].name,type:2};local_api._rename(i,$.cookie("appkey"),function(i){if(0==i.status){var l={path:"/upload/"+o[n].newPath+i.name,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path,name:i.name},s={id:n};local_api._update("document",s,l,$.cookie("appkey"),function(o){a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),t[a]&&e(t,a),a==t.length&&F(p)})}else a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),t[a]&&e(t,a),a==t.length&&F(p)})}else{var l={path:"/upload/"+o[n].newPath,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path},s={id:n};local_api._update("document",s,l,$.cookie("appkey"),function(o){a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),a==t.length&&F(p),t[a]&&e(t,a)})}}(a,0)})}function L(e){local_api._list("document",{type:"0|1|2|4"},"","did|id",1,-1,$.cookie("appkey"),function(t){o=t.data,e&&e()})}function F(e){L(),local_api._list("document",{type:"0|1|2|4",u_path:"^"+$.cookie("tree_path")},"","did|id",1,-1,$.cookie("appkey"),function(a){0==a.status&&a.total&&(t=a.data,e=e||a.data[0].pid,u=c.fileId||u||a.data[0].id,d=d||a.data[0].tree_path,r=r||a.data[0].u_path,c.fileId&&local_api._get("document",{id:c.fileId},"",$.cookie("appkey"),function(e){e.data&&(d=e.data.tree_path,r=e.data.u_path)}),c.fileId=null,$(".file-list").empty(),$("#tree-menu").empty(),B(),w.innerHTML=createFilesHtml(t,u),$(document).on("click",".file-list .file-item",z),function(e){var t=[];customers=e;for(var a=0;a<e.length;a++)t.push(e[a].name);for(var o={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(u=a.id,$.cookie("contentId",u),d=a.treePath,r=a.u_path,X(u))}}},n={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(assignFid=a.id,assignTreePath=a.treePath,assignU_path=a.u_path,assignPath=a.path)}}},i=[],l=[],a=0;a<e.length;a++)i.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:Y[e[a].type],path:e[a].path}),l.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:Y[e[a].type],path:e[a].path});if($.fn.zTree.init($("#tree-menu"),o,i),$.fn.zTree.init($("#documentTreeAssign"),n,l),u>=0){var s=$.fn.zTree.getZTreeObj("tree-menu"),c=s.getNodeByParam("id",u,null);c&&(d=c.treePath,r=c.u_path,s.selectNode(c))}}(t),P.innerHTML=createPathNavHtml(t,u),X(u),tools.addEvent(P,"click",S))})}$("#divDocAudit").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档审核",buttons:{"确定":function(){!function(){createOperate("文档审核");var e={ispass:$("#divDocAudit input[name]:checked").val()},t={tree_path:j.join("|"),type:3};local_api._update("document",t,e,$.cookie("appkey"),function(e){console.log(e),showTips("ok","审核成功！"),$("#divDocAudit").dialog("close")})}()},"取消":function(){$("#divDocAudit").dialog("close")}}}),$("#passDoc").on("click",function(){D=[],j=[],K().length?(K().forEach(e=>{N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path)}),console.log(N,j),$("#divDocAudit").dialog("open"),local_api._list("document",{tree_path:j.join("|"),type:3},"","",1,-1,$.cookie("appkey"),function(e){console.log(e)})):showTips("err","请选择文件！")}),$("#printCode").on("click",function(e){e.stopPropagation(),createOperate("打印二维码"),D=[],j=[],A=[],K().length?(K().forEach(e=>{N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path)}),console.log(N,j),function(e){var t={tree_path:e.join("|"),type:2,did:">0"};local_api._list("document",t,"did,name","did",1,-1,$.cookie("appkey"),function(e){var t=e.data,a=$("#qrcodePrint")[0]||document.createElement("div");a.id="qrcodePrint";var o='<ul class="qrcodePrint">';t.forEach(e=>{o+=`<li><img src="http://h5.bibibaba.cn/pay/wicare/wxpayv3/qrcode.php?data=${e.did}"><span>${e.did}</span></li>`}),o+="</ul>",a.innerHTML=o,$("#qrcodePrint")[0]?($(a).empty(),$(a).append(o)):$("body").append(a);var n=window.document.body.innerHTML,i=$("#qrcodePrint").html();window.document.body.innerHTML=i,function(e){var t,a=!0;!function e(o){$(".qrcodePrint img").each(function(){if(console.log(this.height),0===this.height)return a=!1,!1});a?(clearTimeout(t),o()):(a=!0,t=setTimeout(function(){e(o)},500))}(function(){window.print(),window.document.body.innerHTML=e,h()})}(n)})}(j)):showTips("err","请选择文件！")}),$("#divDocumentAssign").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){q()},"取消":function(){$("#divDocumentAssign").dialog("close")}}}),$(".move").on("click",function(e){K().length?(console.log(H()),$("#divDocumentAssign").dialog("option","title","移动"),$("#divDocumentAssign").dialog("open")):showTips("err","请选择需要移动的案卷或分类")}),F(p);var z=function(t){console.log(t.currentTarget,"filelist");var o=tools.getTarget(t);if(o.className.indexOf("docProo")>-1&&function(t){I=!1,e=t.id.slice("docPro_".length,t.id.length),console.log(e),local_api.getTableColumns("docProp",$.cookie("appkey"),function(t){t.err||(C=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),t.row.forEach(e=>{-1==E.indexOf(e.Field)&&$("#someProp").append(`<option value="${e.Field}">${e.Field}</option>`)})),local_api._get("docProp",{fid:e},"",$.cookie("appkey"),function(e){if(console.log(e),0==e.status){if(e.data){for(var t in M=!1,$("#name").val(e.data.name),$("#saveExpireIn").val(e.data.saveExpireIn),$("#createdAt").val(e.data.createdAt),$("#num").val(e.data.num),$("#page").val(e.data.page),$("#did").val(e.data.did),$("#qnum").val(e.data.qnum),$("#lnum").val(e.data.lnum),$("#jnum").val(e.data.jnum),$("#cnum").val(e.data.cnum),$("#ce").val(e.data.ce),$("#newPropLi").empty(),e.data)if(-1==E.indexOf(t)&&e.data[t]){var a=document.createElement("li");a.style.marginTop="10px",a.dataset=t;var o=` \n                                        <label class="ellipsis" title="${t}">${t}</label>\n                                        <input value="${e.data[t]}" class="form-control" style="width:60%"/>\n                                    `;a.innerHTML=o,$("#newPropLi").append(a)}}else M=!0,$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0);$("#divDocPro").dialog("open")}})})}(t.target),o.className.indexOf("openProo")>-1&&function(e){createOperate("打开密集柜");var t=e.id.slice("openProo_".length,e.id.length);local_api._get("docProp",{fid:t},"",$.cookie("appkey"),function(e){if(e.data){var t=parseInt(e.data.qnum||0),a=parseInt(e.data.lnum||0),o=parseInt(e.data.jnum||0),n=parseInt(e.data.cnum||0),i=parseInt(e.data.ce||0),l=parseInt(e.data.bnum||1);if(t>0&&a>0&&o>0&&n>0&&i>=0){var s={qu:t,lie:a,jie:o,ceng:n,ce:i,bh:l,name:e.data.did,status:1};local_api._delete("playApp",{id:">0"},$.cookie("appkey"),function(e){local_api._create("playApp",s,$.cookie("appkey"),function(e){var t=e.id,a=setInterval(()=>{local_api._get("playApp",{id:t},"",$.cookie("appkey"),function(e){1!=e.data.status&&(clearInterval(a),2==e.data.status?showTips("ok","打开成功！"):3==e.data.status?showTips("err","密集柜连接失败，请检查是否已连接！"):showTips("err","打开失败，请重新打开！"))})},1e3)})})}else showTips("err","无位置信息，无法打开密集柜！")}else showTips("err","无位置信息，无法打开密集柜！")}),console.log(t)}(t.target),o.className.indexOf("folder")>-1||function(e){var t=parseInt(e.target.dataset.type);if([0,1,2,4].indexOf(t)>-1)return!0;if("file-title"==e.target.className){var a=parseInt(e.target.parentNode.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}if("file-title-box"==e.target.className){var a=parseInt(e.target.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}return!1}(t)){if(a=$(".file-list").scrollTop(),tools.parents(o,".item")){var n=(o=tools.parents(o,".item")).dataset.fileId;u=n,$.cookie("contentId",u);var i=$.fn.zTree.getZTreeObj("tree-menu"),l=i.getNodeByParam("id",u,null);l&&(d=l.treePath,r=l.u_path,i.selectNode(l)),X(n)}}else{console.log($(".item",t.currentTarget).data());var s=$(".item",t.currentTarget).data(),c=`/js/pdf/generic/web/viewer.html?file=${o.dataset.filepath}`;3==s.type&&(c="/pdfView?fileid="+s.fileId,window.open(c,"_blank"))}},S=function(e){var t=tools.getTarget(e);if(tools.parents(t,"a")){var a=t.dataset.fileId;u=a,$.cookie("contentId",u);var o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("id",u,null);n&&(d=n.treePath,r=n.u_path,o.selectNode(n)),X(a)}},B=function(){$(document).off("click",".file-list .file-item",z),tools.removeEvent(P,"click",S)};var Y={0:"./img/icon-file-s.svg",1:"./img/icon-file-s.svg",2:"./img/icon-file-s1.svg",4:"./img/icon-file-s2.svg"};function X(e){a&&setTimeout(()=>{$(".file-list")[0].scrollTop=a},1e3),v=[],t.forEach(t=>{t.id==e&&(1==t.type||0==t.type?($("#folder1").show(),$("#folder2").show(),$("#folder3").hide()):($("#folder1").hide(),$("#folder2").hide(),$("#folder3").show()),v.push(t))}),local_api._list("document",{pid:e,u_path:"^"+r},"","did|id",1,-1,$.cookie("appkey"),function(a){$(".file-list").empty();var o=!!a.total;v=v.concat(a.data),console.log(o),o?(b.style.display="none",w.innerHTML=createFilesHtml(v,e)):(b.style.display="block",w.innerHTML=""),P.innerHTML=createPathNavHtml(t,e),J=tools.$(".file-item",w),tools.each(J,function(e,t){G(e)}),tools.removeClass(V,"checked"),u=e,$.cookie("contentId",u)})}tools.addEvent(tools.$(".mod-action-wrap")[1],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(Z(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",U)):void 0});var U=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;Z(),tools.removeEvent(document,"mouseover",U)}};function Z(){tools.$("#btn-change .action-item-con").forEach(e=>{e.style.background="#fff"}),tools.$("#btn-change .act-txt").forEach(e=>{e.style.display="none"})}for(var R=0;R<tools.$(".mod-action-wrap")[1].children.length;R++)tools.addEvent(tools.$(".mod-action-wrap")[1].children[R],"click",function(e){console.log(tools.hasClass(this,"act")),this==tools.$(".mod-action-wrap")[1].children[0]?tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[1].className="action-item",tools.addClass(tools.$(".file-list")[0],"f_detail")):tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[0].className="action-item",tools.removeClass(tools.$(".file-list")[0],"f_detail"))});var J=tools.$(".file-item",w),V=tools.$(".cheched-all")[0],W=tools.$(".checkbox",w);function G(e){var t=tools.$(".checkbox",e)[0];tools.addEvent(e,"mouseenter",function(){tools.addClass(this,"file-checked")}),tools.addEvent(e,"mouseleave",function(){tools.hasClass(t,"checked")||tools.removeClass(this,"file-checked")}),tools.addEvent(t,"click",function(e){console.log(e,"thischeck"),W=tools.$(".checkbox",w),tools.toggleClass(this,"checked")?K().length==W.length&&tools.addClass(V,"checked"):tools.removeClass(V,"checked"),tools.stopPropagation(e)})}function K(){var e=[];return tools.each(W,function(t,a){tools.hasClass(t,"checked")&&e.push(J[a])}),e}tools.each(J,function(e,t){G(e)}),console.log($(".file-list .checkbox")),tools.addEvent(V,"click",function(e){J=tools.$(".file-item",w),W=tools.$(".checkbox",w),tools.toggleClass(this,"checked")?tools.each(J,function(e,t){tools.addClass(e,"file-checked"),tools.addClass(W[t],"checked")}):tools.each(J,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked")})}),tools.addEvent(tools.$(".mod-action-wrap")[0],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(ee(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",Q)):void 0});var Q=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;ee(),tools.removeEvent(document,"mouseover",Q)}};function ee(){tools.$(".mod-nav .action-item-con").forEach(e=>{e.style.background="#fff"}),tools.$(".mod-nav .act-txt").forEach(e=>{e.style.display="none"})}var te=null,ae=null,oe=0;oe=0;tools.addEvent(tools.$(".main")[0],"mousedown",function(e){var t=tools.getTarget(e);tools.parents(t,".nav-a")||(oe=e.clientX,disY=e.clientY,tools.addEvent(document,"mousemove",le),tools.addEvent(document,"mouseup",se),e.preventDefault())});var ne=!1;function ie(e){if(console.log(e.target),e.target,!ae){ae=document.createElement("div"),document.body.appendChild(ae);$(ae).css({position:"fixed",width:"150px",height:"40px"});var t=`<div class="selectboxMoveone">\n                        <div>\n                            <span></span>\n                            <span class="ellipsis">${$(".file-title",K()[0]).text()}</span>\n                        </div>\n                        <span class="moveleng">${K().length}</span>\n                    </div>\n                    ${K().length>1?'<div class="selectboxMovemore"></div>':""}\n                    `;$(ae).append(t)}$(ae).css({top:e.clientY+2,left:e.clientX+2})}function le(e){function t(){Math.abs(e.clientX-oe)>20||Math.abs(e.clientY-disY)>20?(te||(te=document.createElement("div"),document.body.appendChild(te),te.className="select-box"),console.log(te,"hi"),te.style.display="block",te.style.width=Math.abs(e.clientX-oe)+"px",te.style.height=Math.abs(e.clientY-disY)+"px",te.style.left=Math.min(e.clientX+2,oe-2)+"px",te.style.top=Math.min(e.clientY+2,disY-2)+"px",tools.each(J,function(e,t){tools.collisionRect(te,e)?(tools.addClass(e,"file-checked"),tools.addClass(W[t],"checked")):(tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked"))}),K().length==W.length?tools.addClass(V,"checked"):tools.removeClass(V,"checked")):te&&(te.style.display="none")}ae?ie(e):(ne?K().indexOf(e.target.parentNode)>-1?ie(e):function e(t,a,o){var o=o;var n=$(t).parent()[0];"BODY"==n.nodeName?o(!1):n.className.indexOf(a)>-1?o(n):e(n,a,o)}(e.target,"file-item",function(a){console.log(a,"paen"),a&&K().indexOf(a)>-1?ie(e):(ne=!1,t())}):t(),J=tools.$(".file-item",w),W=tools.$(".checkbox",w))}function se(e){if(tools.removeEvent(document,"mousemove",le),tools.removeEvent(document,"mouseup",se),te&&(te.style.display="none"),ne=!ne,ae)ne=!0,$(ae).remove(),ae=null,function(e){if(e.target.id.indexOf("tree-menu")>-1){var t=e.target.id.split("_"),a=t[0]+"_"+t[1],o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("tId",a,null);n&&(assignFid=n.id,assignTreePath=n.treePath,assignU_path=n.u_path,assignPath=n.path,q())}}(e);else if(console.log(m),te)$(te).remove(),te=null;else{var t=e.target.parentNode.className;"nav"!=t&&"file-show"!=t&&"content clearfix"!=t||(tools.each(J,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked")}),tools.removeClass(V,"checked"),ne=!1)}}var ce,de=tools.$(".create")[0];function re(e){b.style.display="none";var t=w.firstElementChild,a=createFileElement({title:"",id:(new Date).getTime(),type:e});w.insertBefore(a,t);var o=$(".file-title",a);o.css("display","none"),o.parent().append('<span class="file-edtor"> <input type="text" value="" class="edtor" autofocus="autofocus"></span>');var n=$(".edtor",a);n.focus(),$(".file-edtor",a).on("mousedown",function(e){e.stopPropagation()}),$(n).on("keyup",function(e){13==e.keyCode&&pe()}),de.isCreateFile=!0,tools.addEvent(document,"mousedown",pe)}function pe(e){if(createOperate("新建"),de.isCreateFile){var t=w.firstElementChild,a=tools.$(".edtor",t)[0].value.trim();if(""===a)w.removeChild(t),""===w.innerHTML&&(b.style.display="block");else{var o=tools.$(".file-title",t)[0],n=$(".file-edtor",t);console.log(t),o.style.display="block",o.innerHTML=a,n.remove();var i={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,name:a,type:ce,u_path:r};local_api._create("document",i,$.cookie("appkey"),function(e){var t=d+","+e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){F(p),2==ce?showTips("ok","新建案卷成功!"):1==ce?showTips("ok","新建分类成功!"):4==ce&&showTips("ok","新建组成功!")})})}de.isCreateFile=!1,tools.removeEvent(document,"mousedown",pe)}}$(".create").on("click",function(){$(".create_file").toggleClass("act")}),$(document).on("mousedown",function(){$(".create_file").hasClass("act")&&$(".create_file").toggleClass("act")}),$("#folder1").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=1,re(1)}),$("#folder2").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=2,re(2)}),$("#folder3").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=4,re(4)});var ue=tools.$(".rename")[0];tools.addEvent(ue,"mouseup",function(){if(J=tools.$(".file-item",w),W=tools.$(".checkbox",w),createOperate("重命名"),K().length)if(K().length>1)showTips("err","只能对单个文件重命名！");else{var e=$(".file-checked .file-title"),t=$(".file-checked .item").data().fileId,a=$(".file-checked .item").data().tree_path,o=$(".file-checked .item").data().type;if(console.log($(".file-checked .item").data()),0==$(".file-checked .item").data().type)return void showTips("err","无法对客户文件夹进行重命名!");var n=e.text(),i=`<span class="file-edtor"> <input type="text" value="${n}" class="edtor"></span>`;e.css("display","none"),e.parent().append(i);var l=$(".file-checked .edtor"),s=$(".file-checked .file-edtor")[0];function c(e){if(!e||e.target.parentNode!=s){var i=l.val().trim();if(""==i)showTips("err","请输入文件名！");else{var d,r,u=f(a);3==o?(d=u+n,r=u+i):(d=u,r=u.slice(0,u.lastIndexOf(n))+i),console.log(u);var m={type:1,oldPath:d,newPath:r};local_api._rename(m,$.cookie("appkey"),function(e){console.log(e),0==e.status?local_api._update("document",{id:t},{name:i},$.cookie("appkey"),function(e){0==e.status&&(showTips("ok","重命名成功"),F(p))}):(showTips("err",e.message),F(p))})}tools.removeEvent(document,"mousedown",c)}}l.select(),$(".file-checked .file-edtor").on("mousedown",function(e){e.stopPropagation()}),l.on("keypress",function(e){13==e.keyCode&&c()}),tools.addEvent(document,"mousedown",c)}else showTips("err","请选择文件！")}),tools.addEvent(tools.$(".nav-box")[0],"click",function(e){console.log(tools.getTarget(e)),console.log(tools.getTarget(e).parentNode),tools.hasClass(tools.getTarget(e).parentNode,"nav-list")&&(tools.each(tools.$(".nav-list.nav-current"),function(e){console.log(e.className),tools.removeClass(e,"nav-current")}),tools.addClass(tools.getTarget(e).parentNode,"nav-current")),console.log(tools.hasClass(tools.getTarget(e).parentNode,"nav-list"))}),tools.addEvent(tools.$("#search")[0],"focus",function(){var e=tools.$("#_search_bar")[0];tools.addClass(e,"focus")}),tools.addEvent(tools.$("#search")[0],"blur",function(){var e=tools.$("#_search_bar")[0];setTimeout(()=>{tools.removeClass(e,"focus")},200)}),$("#search").on("keypress",function(e){createOperate("文件检索"),13==e.keyCode&&""!=e.target.value.trim()&&(location.href="/hightSearch?query="+e.target.value.trim())});$(".upload").on("click",function(e){e.stopPropagation(),me()}),$(".upload-file").on("click",function(e){e.stopPropagation();var t=e.target.parentNode,a=e.target.parentNode.parentNode,o=$(".upload-file").children().children();t!=o[0]&&a!=o[0]||me()});function me(){createOperate("文件上传");var e=document.createElement("input");e.type="file",e.multiple="multiple",$(e).change(function(e){console.log(this.files);var t=this.files,a=i.length+0;$(".mod-tasks .tasks-header").removeClass("result-succt").addClass("tasking-nor");var c=d.split(","),m="";function h(e){$(e).on("click",function(e){console.log(e);var t=e.currentTarget.dataset.file_id;console.log(t),$(e.currentTarget).hasClass("waiting")&&$(e.target).hasClass("btn-icon")&&(s.push(parseInt(t)),v(3,t)),$(e.currentTarget).hasClass("cancel")&&$(e.target).hasClass("btn-icon")})}function v(e,t){var a=i[t],o=uploadHtml(e,a,t);h(o),$(n[t],l).replaceWith(o),n.splice(t,1,o)}function g(e,t,o,i){var l=new FormData;l.append(e.last_name,o);var s="/upload?path="+encodeURI(f(e.tree_path));http({type:"POST",url:s,data:l,onProgress:function(e){console.log(e.percent),console.log($(n[a]),a,"23")},onSuccess:function(a){console.log(a),a.fmd5=t,0==a.status?function(e,t,a){var o={pid:t.id,size:e.file.size,type:3,name:e.file.filename};local_api._get("document",o,"",$.cookie("appkey"),function(o){if(0!=o.status||o.data){if(0==o.status&&o.data){var n={id:o.data.id,tree_path:o.data.tree_path};a(n)}}else{var i=e.file.mimetype.indexOf("image")>-1?"png":"txt",l={size:e.file.size,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t.id,type:3,filetype:i,name:e.file.filename,path:"/upload/"+f(t.tree_path)+e.file.filename,f_md5:e.fmd5,u_path:r,ispass:1};local_api._create("document",l,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n={id:e.id,tree_path:o};local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){a(n)})})}})}(a,e,function(e){i(e)}):i(a)},onError:function(e){i(res)}})}dataControl.getParents(o,c[c.length-1]).reverse().forEach(e=>{m+=e.name+"/"}),m,Array.prototype.forEach.call(t,function(e,t){console.log(e),$(".mod-tasks").show();var o=uploadHtml(0,e,a+t);h(o),n.push(o),i.push(e),l.append(o)}),function e(){var t=i[a];if(s.indexOf(a)>-1)return a++,void e();if(i.length==a)$(".mod-tasks .tasks-header").removeClass("tasking-nor").addClass("result-succ"),$(".mod-tasks .summary-wrapper .txt").text("任务已完成");else{var o=(a/i.length).toFixed(1);$(".mod-tasks .summary-wrapper .before").css("transform",`scaleX(${o})`),$(".mod-tasks .summary-wrapper .txt").text(`${a}/${i.length}项任务进行中`)}t&&function(e,t,a){get_filemd5sum(e,function(t){var o=e.name;!function(e,t){var a=o.indexOf("【"),n=o.indexOf("】");if(a>-1&&n>0){var i=o.slice(a+1,n),l=o.slice(n+1,o.length),s=i.split("_"),c={did:s[0],name:s[0]+s[1],tree_path:"^"+d,pid:u};local_api._get("document",c,"",$.cookie("appkey"),function(e){if(0==e.status&&e.data)if(s[2]){var a={name:s[2],tree_path:"^"+e.data.tree_path,pid:e.data.id};local_api._get("document",a,"",$.cookie("appkey"),function(a){if(a.data)t(Object.assign(a.data,{last_name:l}));else{var o={name:s[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:e.data.id,u_path:r};local_api._create("document",o,$.cookie("appkey"),function(a){var o=e.data.tree_path+","+a.id,n={id:a.id,tree_path:o,last_name:l};local_api._update("document",{id:a.id},{tree_path:o},$.cookie("appkey"),function(e){t(n)})})}})}else t(Object.assign(e.data,{last_name:l}));else{var o={name:s[0]+s[1],did:s[0],type:2,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,u_path:r};local_api._create("document",o,$.cookie("appkey"),function(e){var a=d+","+e.id,o={id:e.id,tree_path:a,last_name:l};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(e){if(s[2]){var a={name:s[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:o.id,u_path:r};local_api._create("document",a,$.cookie("appkey"),function(e){var a=o.tree_path+","+e.id,n={id:e.id,tree_path:a,last_name:l};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(e){t(n)})})}})})}})}else{var p={id:u,tree_path:d,last_name:o};t(p)}}(0,function(o){L(function(){var n="",i=o.last_name,l="",s=0;i.lastIndexOf(".")>-1?(n=i.slice(0,i.lastIndexOf(".")),l=i.slice(i.lastIndexOf("."))):(n=i,l="");var c=t;-1!=c&&function t(){s++;var d={name:i,tree_path:"^"+o.tree_path,type:3};local_api._get("document",d,"",$.cookie("appkey"),function(d){0==d.status&&d.data?d.data.f_md5==c?a(d.data):(i=n+"("+s+")"+l,t()):0!=d.status||d.data||(o.last_name=i,g(o,c,e,a))})}()})})})}(t,0,function(t){console.log($(n[a],l),a,"22"),t.id?v(1,a):v(2,a),a++,t.name||F(p),e()})}()}),e.click()}$(".delete").on("click",function(e){console.log(K());var t=K();if(K().length){var a=[],o=[],n={},i=[],l=[];t.forEach(e=>{var t=$(".item",e).data().type,s={};if(0!=t?(a.push("^"+$(".item",e).data().tree_path),3==t?(s.tree_path="^"+$(".item",e).data().tree_path,s.path=$(".item",e).data().filepath):(s.tree_path="^"+$(".item",e).data().tree_path,s.path=f($(".item",e).data().tree_path)),l.push(s)):o.push("^"+$(".item",e).data().tree_path),!n[t]){n[t]=1;var c=1==t?"分类":2==t?"案卷":3==t?"文件":"";i.push(c)}}),createOperate("文件删除"),console.log(l),o.length>0&&showTips("err","无法对客户文件夹进行删除操作");var s=`确定要删除${t.length>1?"这些":"这个"}${i.join("/")}？`;a.length&&confirm(s)&&l.forEach((e,t)=>{local_api._fsDelete({curPath:e.path},$.cookie("appkey"),function(a){0==a.status&&local_api._delete("document",{tree_path:e.tree_path},$.cookie("appkey"),function(e){t==l.length-1&&(F(p),showTips("ok",`删除${i.join("/")}成功!`))})})})}else showTips("err","请选择文件或档案！")}),$(".logout").on("mousedown",function(e){e.stopPropagation(),location.href="/logout"}),$("#showList").click(function(){$(".mod-tasks").toggleClass("expand")}),$("#hideList").click(function(){$(".mod-tasks").hide(),n=[],i=[],l.empty(),fileIndex=0}),$("#divCombind").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){!function(){var e={handle_json:{input:{},output:""},update:{path:"",name:"",size:""},query:{id:""},delete_j:{id:""}},t=[],a=K();a.length?a.forEach(e=>{var a=$(".item",e).data();a.name=$(".item .file-title",e).text(),a.size=backFileSize($(".item ul>li:nth-child(1)",e).text()),t.push(a)}):showTips("err","请选择pdf文件进行合并！");if(!t.length)return void showTips("err","请选择pdf文件进行合并！");var o=0,n=[];t.forEach((t,a)=>{o+=t.size,e.handle_json.input[a]=f(t.tree_path)+t.name,0==a?(e.query.id=t.fileId,e.update.name=$("#renameCombind").val().trim()+".pdf",e.update.path="/upload/"+f(t.tree_path)+$("#renameCombind").val().trim()+".pdf",e.handle_json.output=f(t.tree_path)+$("#renameCombind").val().trim()+".pdf"):n.push(t.fileId)}),e.delete_j.id=n.join("|"),e.update.size=o,createOperate("合并文件"),confirm("确定合并已选择的文件")?local_api._fsCombind(e.handle_json,$.cookie("appkey"),function(t){0==t.status?local_api._update("document",e.query,e.update,$.cookie("appkey"),function(t){local_api._delete("document",e.delete_j,$.cookie("appkey"),function(e){showTips("ok","合并成功!"),$("#divCombind").dialog("close"),X(u)})}):(showTips("err","合并失败!"),$("#divCombind").dialog("close"))}):$("#divCombind").dialog("close")}()},"取消":function(){$("#divCombind").dialog("close")}}}),$("#combind").on("click",function(){$("#divCombind").dialog("open")}),$("#export").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){var t=$(this)[0].files;he(t)}),e.click()}),$("#exportPorp").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){$(this)[0].files}),e.click()});var he=function(e){createOperate("导入台账");var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}),n=a.SheetNames,i={},l=o.filter(e=>1==e.type&&e.tree_path.indexOf(d)>-1);for(var s in n.forEach((e,t)=>{l.forEach(t=>{e.trim()==t.name&&(console.log(t),i[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),i);console.log(i)}}}function f(e){var t="";return e.split(",").filter(e=>""!=e).forEach(e=>{o.forEach(a=>{e==a.id&&(t+=a.name+"/")})}),t}!function(){r=$.cookie("tree_path");var e,t,v,g=tools.$(".header")[0],_=tools.$(".weiyun-content")[0],k=g.offsetHeight,y=tools.$(".content")[0],w=tools.$(".file-list")[0];console.log(data),tools.$(".tree-menu")[0];var P=tools.$(".path-nav")[0],b=tools.$(".g-empty")[0];function x(){var e=document.documentElement.clientHeight;_.style.height=e-k+"px",y&&(y.style.height=e-k-62+"px"),w&&(w.style.height=e-k-93+"px")}function T(){var e="";return[1,2,3,4,5,6,7,8,9].forEach(t=>{e+=`<option value="${t}">${t}</option>`}),e}$.cookie("uid"),x(),window.onresize=x,$("#qnum").empty().append(T()),$("#lnum").empty().append(T()),$("#jnum").empty().append(T()),$("#cnum").empty().append(T());var C=[],E=["id","fid","u_path","did","name","saveExpireIn","createdAt","num","page","qnum","lnum","jnum","cnum","ce","bnum","pname","lname"];function O(e){var t=document.createElement("li");t.style.marginTop="10px",t.dataset=e;var a=` \n            <label class="ellipsis" title="${e}">${e}</label>\n            <input value="" class="form-control" style="width:50%"/>\n            <button class="btn btn-primary newBtn" style="">删除</button>\n        `;t.innerHTML=a,$("#newPropLi").append(t),console.log($(t)),$("button",t).on("click",function(t){console.log(e),C.splice(C.indexOf(e),1),$(t.target).parent().remove()})}$("#divDocPro").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"保存":function(){I?function(){if(console.log(D),D.length){for(var e=[],t={u_path:r,name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),did:$("#did").val(),num:$("#num").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}D.forEach(a=>{var n=Object.assign({},t,o);n.fid=a,e.push(n)}),confirm("批量设置属性会覆盖案卷原有属性，是否批量设置属性")&&local_api._delete("docProp",{fid:D.join("|")},$.cookie("appkey"),function(t){console.log(t),local_api._createBatch("docProp",{data:JSON.stringify({data:e})},$.cookie("appkey"),function(e){createOperate("批量设置案卷属性"),$("#divDocPro").dialog("option","title","属性"),$("#divDocPro").dialog("close")})}),console.log(e)}else showTips("err","该档案下没有案卷可设置")}():function(){if(createOperate("单个设置属性"),M){for(var t={name:$("#name").val(),fid:e,u_path:r,saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},a=$("#newPropLi li"),o={},n=0;n<a.length;n++){var i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(t,o),console.log(t),local_api._create("docProp",t,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}else{var l={name:$("#name").val(),saveExpireIn:$("#saveExpireIn").val(),createdAt:$("#createdAt").val(),num:$("#num").val(),did:$("#did").val(),page:$("#page").val(),qnum:$("#qnum").val(),lnum:$("#lnum").val(),jnum:$("#jnum").val(),cnum:$("#cnum").val(),ce:$("#ce").val()},s={fid:e};for(a=$("#newPropLi li"),o={},n=0;n<a.length;n++){i=a[n];o[$("label",i).text()]=$("input",i).val()}Object.assign(l,o),console.log(l),local_api._update("docProp",s,l,$.cookie("appkey"),function(t){local_api._update("document",{id:e},{did:$("#did").val()},$.cookie("appkey"),function(e){$("#divDocPro").dialog("close")})})}}()},"取消":function(){$("#divDocPro").dialog("close")}}}),$("#selectProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"选择自定义属性",buttons:{"确定":function(){$("#selectProp").dialog("close")}}}),$("#newCustomProp").dialog({width:400,maxHeight:400,autoOpen:!1,title:"添加新属性",buttons:{"确定":function(){var e;e=$("#newPropname").val(),local_api._createColumn("docProp",{name:e,size:50},"",function(t){createOperate("添加自定义属性"),t.err?showTips("err","添加属性失败"):(O(e),C.push(e),$("#someProp").append(`<option value="${e}">${e}</option>`),$("#newCustomProp").dialog("close"))})},"取消":function(){$("#newCustomProp").dialog("close")}}}),$("#someProp").on("change",function(e){console.log(this.value),0!=this.value&&(-1==C.indexOf(this.value)?(C.push(this.value),O(this.value)):showTips("err","该属性已存在"))}),$("#newProp").click(function(){$("#newCustomProp").dialog("open")}),$("#addCustom").click(function(){$("#selectProp").dialog("open")});var I=!1,N=[],j=[],A=[],D=[];$("#someProo").on("click",function(){I=!0,N=[],j=[],A=[],D=[],console.log(K()),K().length?(K().forEach(e=>{3!=$(".item",e).data().type&&(N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path),A.push($(".item .file-title",e).text()))}),console.log(N,j,A),local_api.getTableColumns("docProp",$.cookie("appkey"),function(e){e.err||(C=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),e.row.forEach(e=>{-1==E.indexOf(e.Field)&&$("#someProp").append(`<option value="${e.Field}">${e.Field}</option>`)})),local_api._list("document",{tree_path:j.join("|"),type:2},"","",1,-1,$.cookie("appkey"),function(e){$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0),$("#divDocPro").dialog("option","title","批量设置属性"),$("#divDocPro").dialog("open"),e.data.forEach(e=>{D.push(e.id)})})})):showTips("err","请选择文件！")});var M=!1;function H(){for(var e=K(),t={tree_path:[],id:[]},a=0;a<e.length;a++)t.tree_path.push("^"+$(".item",e[a]).data().tree_path),t.id.push($(".item",e[a]).data().fileId);return t}function q(){createOperate("移动");var e=H().tree_path,t=H().id;console.log(assignFid,assignTreePath,assignU_path);var a=[];local_api._list("document",{tree_path:e.join("|")},"","",1,-1,$.cookie("appkey"),function(e){e.data.forEach(o=>{var n={};if(n[o.id]={},t.indexOf(o.id)>-1){n[o.id].pid=assignFid;var i=o.tree_path.indexOf(o.id),l=o.tree_path.length,s=assignTreePath+","+o.tree_path.slice(i,l);n[o.id].oldtree_path=o.tree_path,n[o.id].tree_path=s,n[o.id].olePath=f(o.tree_path),n[o.id].newPath=f(s),n[o.id].u_path=assignU_path,n[o.id].name=o.name,n[o.id].type=o.type,a.push(n),function t(o,n){var i=dataControl.getChildById(e.data,o);i.length&&i.forEach(e=>{var i={};i[e.id]={},i[e.id].pid=o,i[e.id].oldtree_path=e.tree_path;var l=n+","+e.id;i[e.id].tree_path=l,i[e.id].olePath=f(e.tree_path),i[e.id].newPath=f(l),i[e.id].u_path=assignU_path,i[e.id].name=e.name,i[e.id].type=e.type,a.push(i),t(e.id,l)})}(o.id,s)}}),console.log(a),$("#divDocumentAssign").dialog("close"),function e(t,a){console.log(t[a]);var o=t[a];for(var n in o)if(3==o[n].type){var i={oldPath:o[n].olePath,newPath:o[n].newPath,name:o[n].name,type:2};local_api._rename(i,$.cookie("appkey"),function(i){if(0==i.status){var l={path:"/upload/"+o[n].newPath+i.name,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path,name:i.name},s={id:n};local_api._update("document",s,l,$.cookie("appkey"),function(o){a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),t[a]&&e(t,a),a==t.length&&F(p)})}else a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),t[a]&&e(t,a),a==t.length&&F(p)})}else{var l={path:"/upload/"+o[n].newPath,tree_path:o[n].tree_path,pid:o[n].pid,u_path:o[n].u_path},s={id:n};local_api._update("document",s,l,$.cookie("appkey"),function(o){a++,showTips("ok",`正在移动目录和文件${a}/${t.length}`),a==t.length&&F(p),t[a]&&e(t,a)})}}(a,0)})}function L(e){local_api._list("document",{type:"0|1|2|4"},"","did|id",1,-1,$.cookie("appkey"),function(t){o=t.data,e&&e()})}function F(e){L(),local_api._list("document",{type:"0|1|2|4",u_path:"^"+$.cookie("tree_path")},"","did|id",1,-1,$.cookie("appkey"),function(a){0==a.status&&a.total&&(t=a.data,e=e||a.data[0].pid,u=c.fileId||u||a.data[0].id,d=d||a.data[0].tree_path,r=r||a.data[0].u_path,c.fileId&&local_api._get("document",{id:c.fileId},"",$.cookie("appkey"),function(e){e.data&&(d=e.data.tree_path,r=e.data.u_path)}),c.fileId=null,$(".file-list").empty(),$("#tree-menu").empty(),B(),w.innerHTML=createFilesHtml(t,u),$(document).on("click",".file-list .file-item",z),function(e){var t=[];customers=e;for(var a=0;a<e.length;a++)t.push(e[a].name);var o={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(u=a.id,$.cookie("contentId",u),d=a.treePath,r=a.u_path,X(u))}}},n={view:{showIcon:!0},check:{enable:!1,chkStyle:"checkbox"},data:{simpleData:{enable:!0}},callback:{onClick:function(e,t,a){parseInt(a.id)>-1&&(assignFid=a.id,assignTreePath=a.treePath,assignU_path=a.u_path,assignPath=a.path)}}},i=[],l=[];for(a=0;a<e.length;a++)i.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:Y[e[a].type],path:e[a].path}),l.push({open:!1,id:e[a].id,treePath:e[a].tree_path,pId:e[a].pid,name:e[a].name,u_path:e[a].u_path,icon:Y[e[a].type],path:e[a].path});if($.fn.zTree.init($("#tree-menu"),o,i),$.fn.zTree.init($("#documentTreeAssign"),n,l),u>=0){var s=$.fn.zTree.getZTreeObj("tree-menu"),c=s.getNodeByParam("id",u,null);c&&(d=c.treePath,r=c.u_path,s.selectNode(c))}}(t),P.innerHTML=createPathNavHtml(t,u),X(u),tools.addEvent(P,"click",S))})}$("#divDocAudit").dialog({width:400,maxHeight:400,autoOpen:!1,title:"文档审核",buttons:{"确定":function(){!function(){createOperate("文档审核");var e={ispass:$("#divDocAudit input[name]:checked").val()},t={tree_path:j.join("|"),type:3};local_api._update("document",t,e,$.cookie("appkey"),function(e){console.log(e),showTips("ok","审核成功！"),$("#divDocAudit").dialog("close")})}()},"取消":function(){$("#divDocAudit").dialog("close")}}}),$("#passDoc").on("click",function(){D=[],j=[],K().length?(K().forEach(e=>{N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path)}),console.log(N,j),$("#divDocAudit").dialog("open"),local_api._list("document",{tree_path:j.join("|"),type:3},"","",1,-1,$.cookie("appkey"),function(e){console.log(e)})):showTips("err","请选择文件！")}),$("#printCode").on("click",function(e){var t;e.stopPropagation(),createOperate("打印二维码"),D=[],j=[],A=[],K().length?(K().forEach(e=>{N.push($(".item",e).data().fileId),j.push("^"+$(".item",e).data().tree_path)}),console.log(N,j),t={tree_path:j.join("|"),type:2,did:">0"},local_api._list("document",t,"did,name","did",1,-1,$.cookie("appkey"),function(e){var t=e.data,a=$("#qrcodePrint")[0]||document.createElement("div");a.id="qrcodePrint";var o='<ul class="qrcodePrint">';t.forEach(e=>{o+=`<li><img src="http://h5.bibibaba.cn/pay/wicare/wxpayv3/qrcode.php?data=${e.did}"><span>${e.did}</span></li>`}),o+="</ul>",a.innerHTML=o,$("#qrcodePrint")[0]?($(a).empty(),$(a).append(o)):$("body").append(a);var n=window.document.body.innerHTML,i=$("#qrcodePrint").html();window.document.body.innerHTML=i,function(e){var t,a=!0;!function e(o){$(".qrcodePrint img").each(function(){if(console.log(this.height),0===this.height)return a=!1,!1}),a?(clearTimeout(t),o()):(a=!0,t=setTimeout(function(){e(o)},500))}(function(){window.print(),window.document.body.innerHTML=e,h()})}(n)})):showTips("err","请选择文件！")}),$("#divDocumentAssign").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){q()},"取消":function(){$("#divDocumentAssign").dialog("close")}}}),$(".move").on("click",function(e){K().length?(console.log(H()),$("#divDocumentAssign").dialog("option","title","移动"),$("#divDocumentAssign").dialog("open")):showTips("err","请选择需要移动的案卷或分类")}),F(p);var z=function(t){console.log(t.currentTarget,"filelist");var o=tools.getTarget(t);if(o.className.indexOf("docProo")>-1&&function(t){I=!1,e=t.id.slice("docPro_".length,t.id.length),console.log(e),local_api.getTableColumns("docProp",$.cookie("appkey"),function(t){t.err||(C=[],$("#someProp").empty(),$("#newPropLi").empty(),$("#someProp").append('<option value="0">可选属性</option>'),t.row.forEach(e=>{-1==E.indexOf(e.Field)&&$("#someProp").append(`<option value="${e.Field}">${e.Field}</option>`)})),local_api._get("docProp",{fid:e},"",$.cookie("appkey"),function(e){if(console.log(e),0==e.status){if(e.data){for(var t in M=!1,$("#name").val(e.data.name),$("#saveExpireIn").val(e.data.saveExpireIn),$("#createdAt").val(e.data.createdAt),$("#num").val(e.data.num),$("#page").val(e.data.page),$("#did").val(e.data.did),$("#qnum").val(e.data.qnum),$("#lnum").val(e.data.lnum),$("#jnum").val(e.data.jnum),$("#cnum").val(e.data.cnum),$("#ce").val(e.data.ce),$("#newPropLi").empty(),e.data)if(-1==E.indexOf(t)&&e.data[t]){var a=document.createElement("li");a.style.marginTop="10px",a.dataset=t;var o=` \n                                        <label class="ellipsis" title="${t}">${t}</label>\n                                        <input value="${e.data[t]}" class="form-control" style="width:60%"/>\n                                    `;a.innerHTML=o,$("#newPropLi").append(a)}}else M=!0,$("#name").val(""),$("#saveExpireIn").val(""),$("#createdAt").val(""),$("#num").val(""),$("#page").val(""),$("#did").val(""),$("#qnum").val(1),$("#lnum").val(1),$("#jnum").val(1),$("#cnum").val(1),$("#ce").val(0);$("#divDocPro").dialog("open")}})})}(t.target),o.className.indexOf("openProo")>-1&&function(e){createOperate("打开密集柜");var t=e.id.slice("openProo_".length,e.id.length);local_api._get("docProp",{fid:t},"",$.cookie("appkey"),function(e){if(e.data){var t=parseInt(e.data.qnum||0),a=parseInt(e.data.lnum||0),o=parseInt(e.data.jnum||0),n=parseInt(e.data.cnum||0),i=parseInt(e.data.ce||0),l=parseInt(e.data.bnum||1);if(t>0&&a>0&&o>0&&n>0&&i>=0){var s={qu:t,lie:a,jie:o,ceng:n,ce:i,bh:l,name:e.data.did,status:1};local_api._delete("playApp",{id:">0"},$.cookie("appkey"),function(e){local_api._create("playApp",s,$.cookie("appkey"),function(e){var t=e.id,a=setInterval(()=>{local_api._get("playApp",{id:t},"",$.cookie("appkey"),function(e){1!=e.data.status&&(clearInterval(a),2==e.data.status?showTips("ok","打开成功！"):3==e.data.status?showTips("err","密集柜连接失败，请检查是否已连接！"):showTips("err","打开失败，请重新打开！"))})},1e3)})})}else showTips("err","无位置信息，无法打开密集柜！")}else showTips("err","无位置信息，无法打开密集柜！")}),console.log(t)}(t.target),o.className.indexOf("folder")>-1||function(e){var t=parseInt(e.target.dataset.type);if([0,1,2,4].indexOf(t)>-1)return!0;if("file-title"==e.target.className){var a=parseInt(e.target.parentNode.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}if("file-title-box"==e.target.className){a=parseInt(e.target.parentNode.dataset.type);if([0,1,2,4].indexOf(a)>-1)return!0}return!1}(t)){if(a=$(".file-list").scrollTop(),tools.parents(o,".item")){var n=(o=tools.parents(o,".item")).dataset.fileId;u=n,$.cookie("contentId",u);var i=$.fn.zTree.getZTreeObj("tree-menu"),l=i.getNodeByParam("id",u,null);l&&(d=l.treePath,r=l.u_path,i.selectNode(l)),X(n)}}else{console.log($(".item",t.currentTarget).data());var s=$(".item",t.currentTarget).data(),c=`/js/pdf/generic/web/viewer.html?file=${o.dataset.filepath}`;3==s.type&&(c="/pdfView?fileid="+s.fileId,window.open(c,"_blank"))}},S=function(e){var t=tools.getTarget(e);if(tools.parents(t,"a")){var a=t.dataset.fileId;u=a,$.cookie("contentId",u);var o=$.fn.zTree.getZTreeObj("tree-menu"),n=o.getNodeByParam("id",u,null);n&&(d=n.treePath,r=n.u_path,o.selectNode(n)),X(a)}},B=function(){$(document).off("click",".file-list .file-item",z),tools.removeEvent(P,"click",S)},Y={0:"./img/icon-file-s.svg",1:"./img/icon-file-s.svg",2:"./img/icon-file-s1.svg",4:"./img/icon-file-s2.svg"};function X(e){a&&setTimeout(()=>{$(".file-list")[0].scrollTop=a},1e3),v=[],t.forEach(t=>{t.id==e&&(1==t.type||0==t.type?($("#folder1").show(),$("#folder2").show(),$("#folder3").hide()):($("#folder1").hide(),$("#folder2").hide(),$("#folder3").show()),v.push(t))}),local_api._list("document",{pid:e,u_path:"^"+r},"","did|id",1,-1,$.cookie("appkey"),function(a){$(".file-list").empty();var o=!!a.total;v=v.concat(a.data),console.log(o),o?(b.style.display="none",w.innerHTML=createFilesHtml(v,e)):(b.style.display="block",w.innerHTML=""),P.innerHTML=createPathNavHtml(t,e),J=tools.$(".file-item",w),tools.each(J,function(e,t){G(e)}),tools.removeClass(V,"checked"),u=e,$.cookie("contentId",u)})}tools.addEvent(tools.$(".mod-action-wrap")[1],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(Z(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",U)):void 0});var U=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;Z(),tools.removeEvent(document,"mouseover",U)}};function Z(){tools.$("#btn-change .action-item-con").forEach(e=>{e.style.background="#fff"}),tools.$("#btn-change .act-txt").forEach(e=>{e.style.display="none"})}for(var R=0;R<tools.$(".mod-action-wrap")[1].children.length;R++)tools.addEvent(tools.$(".mod-action-wrap")[1].children[R],"click",function(e){console.log(tools.hasClass(this,"act")),this==tools.$(".mod-action-wrap")[1].children[0]?tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[1].className="action-item",tools.addClass(tools.$(".file-list")[0],"f_detail")):tools.hasClass(this,"act")||(this.className=this.className+" act",tools.$(".mod-action-wrap")[1].children[0].className="action-item",tools.removeClass(tools.$(".file-list")[0],"f_detail"))});var J=tools.$(".file-item",w),V=tools.$(".cheched-all")[0],W=tools.$(".checkbox",w);function G(e){var t=tools.$(".checkbox",e)[0];tools.addEvent(e,"mouseenter",function(){tools.addClass(this,"file-checked")}),tools.addEvent(e,"mouseleave",function(){tools.hasClass(t,"checked")||tools.removeClass(this,"file-checked")}),tools.addEvent(t,"click",function(e){console.log(e,"thischeck"),W=tools.$(".checkbox",w),tools.toggleClass(this,"checked")?K().length==W.length&&tools.addClass(V,"checked"):tools.removeClass(V,"checked"),tools.stopPropagation(e)})}function K(){var e=[];return tools.each(W,function(t,a){tools.hasClass(t,"checked")&&e.push(J[a])}),e}tools.each(J,function(e,t){G(e)}),console.log($(".file-list .checkbox")),tools.addEvent(V,"click",function(e){J=tools.$(".file-item",w),W=tools.$(".checkbox",w),tools.toggleClass(this,"checked")?tools.each(J,function(e,t){tools.addClass(e,"file-checked"),tools.addClass(W[t],"checked")}):tools.each(J,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked")})}),tools.addEvent(tools.$(".mod-action-wrap")[0],"mouseover",function(e){if("action-item"!=e.target.className)return"action-item-con"==e.target.className?(ee(),e.target.style.background="#f5f6f9",e.target.children[1].style.display="inline-block",void tools.addEvent(document,"mouseover",Q)):void 0});var Q=function(e){if("action-item-con"!=e.target.className){if(e.target.className.indexOf("icon-")>-1)return;ee(),tools.removeEvent(document,"mouseover",Q)}};function ee(){tools.$(".mod-nav .action-item-con").forEach(e=>{e.style.background="#fff"}),tools.$(".mod-nav .act-txt").forEach(e=>{e.style.display="none"})}var te=null,ae=null,oe=0;oe=0;tools.addEvent(tools.$(".main")[0],"mousedown",function(e){var t=tools.getTarget(e);tools.parents(t,".nav-a")||(oe=e.clientX,disY=e.clientY,tools.addEvent(document,"mousemove",le),tools.addEvent(document,"mouseup",se),e.preventDefault())});var ne=!1;function ie(e){if(console.log(e.target),e.target,!ae){ae=document.createElement("div"),document.body.appendChild(ae),$(ae).css({position:"fixed",width:"150px",height:"40px"});var t=`<div class="selectboxMoveone">\n                        <div>\n                            <span></span>\n                            <span class="ellipsis">${$(".file-title",K()[0]).text()}</span>\n                        </div>\n                        <span class="moveleng">${K().length}</span>\n                    </div>\n                    ${K().length>1?'<div class="selectboxMovemore"></div>':""}\n                    `;$(ae).append(t)}$(ae).css({top:e.clientY+2,left:e.clientX+2})}function le(e){function t(){Math.abs(e.clientX-oe)>20||Math.abs(e.clientY-disY)>20?(te||(te=document.createElement("div"),document.body.appendChild(te),te.className="select-box"),console.log(te,"hi"),te.style.display="block",te.style.width=Math.abs(e.clientX-oe)+"px",te.style.height=Math.abs(e.clientY-disY)+"px",te.style.left=Math.min(e.clientX+2,oe-2)+"px",te.style.top=Math.min(e.clientY+2,disY-2)+"px",tools.each(J,function(e,t){tools.collisionRect(te,e)?(tools.addClass(e,"file-checked"),tools.addClass(W[t],"checked")):(tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked"))}),K().length==W.length?tools.addClass(V,"checked"):tools.removeClass(V,"checked")):te&&(te.style.display="none")}ae?ie(e):(ne?K().indexOf(e.target.parentNode)>-1?ie(e):function e(t,a,o){o=o;var n=$(t).parent()[0];"BODY"==n.nodeName?o(!1):n.className.indexOf(a)>-1?o(n):e(n,a,o)}(e.target,"file-item",function(a){console.log(a,"paen"),a&&K().indexOf(a)>-1?ie(e):(ne=!1,t())}):t(),J=tools.$(".file-item",w),W=tools.$(".checkbox",w))}function se(e){if(tools.removeEvent(document,"mousemove",le),tools.removeEvent(document,"mouseup",se),te&&(te.style.display="none"),ne=!ne,ae)ne=!0,$(ae).remove(),ae=null,function(e){if(e.target.id.indexOf("tree-menu")>-1){var t=e.target.id.split("_"),a=t[0]+"_"+t[1],o=$.fn.zTree.getZTreeObj("tree-menu").getNodeByParam("tId",a,null);o&&(assignFid=o.id,assignTreePath=o.treePath,assignU_path=o.u_path,assignPath=o.path,q())}}(e);else if(console.log(m),te)$(te).remove(),te=null;else{var t=e.target.parentNode.className;"nav"!=t&&"file-show"!=t&&"content clearfix"!=t||(tools.each(J,function(e,t){tools.removeClass(e,"file-checked"),tools.removeClass(W[t],"checked")}),tools.removeClass(V,"checked"),ne=!1)}}var ce,de=tools.$(".create")[0];function re(e){b.style.display="none";var t=w.firstElementChild,a=createFileElement({title:"",id:(new Date).getTime(),type:e});w.insertBefore(a,t);var o=$(".file-title",a);o.css("display","none"),o.parent().append('<span class="file-edtor"> <input type="text" value="" class="edtor" autofocus="autofocus"></span>');var n=$(".edtor",a);n.focus(),$(".file-edtor",a).on("mousedown",function(e){e.stopPropagation()}),$(n).on("keyup",function(e){13==e.keyCode&&pe()}),de.isCreateFile=!0,tools.addEvent(document,"mousedown",pe)}function pe(e){if(createOperate("新建"),de.isCreateFile){var t=w.firstElementChild,a=tools.$(".edtor",t)[0].value.trim();if(""===a)w.removeChild(t),""===w.innerHTML&&(b.style.display="block");else{var o=tools.$(".file-title",t)[0],n=$(".file-edtor",t);console.log(t),o.style.display="block",o.innerHTML=a,n.remove();var i={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,name:a,type:ce,u_path:r};local_api._create("document",i,$.cookie("appkey"),function(e){var t=d+","+e.id;local_api._update("document",{id:e.id},{tree_path:t},$.cookie("appkey"),function(e){F(p),2==ce?showTips("ok","新建案卷成功!"):1==ce?showTips("ok","新建分类成功!"):4==ce&&showTips("ok","新建组成功!")})})}de.isCreateFile=!1,tools.removeEvent(document,"mousedown",pe)}}$(".create").on("click",function(){$(".create_file").toggleClass("act")}),$(document).on("mousedown",function(){$(".create_file").hasClass("act")&&$(".create_file").toggleClass("act")}),$("#folder1").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=1,re(1)}),$("#folder2").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=2,re(2)}),$("#folder3").on("mousedown",function(e){e.stopPropagation(),$(".create_file").toggleClass("act"),ce=4,re(4)});var ue=tools.$(".rename")[0];function me(){createOperate("文件上传");var e=document.createElement("input");e.type="file",e.multiple="multiple",$(e).change(function(e){console.log(this.files);var t=this.files,a=i.length+0;$(".mod-tasks .tasks-header").removeClass("result-succt").addClass("tasking-nor");var c=d.split(",");function m(e){$(e).on("click",function(e){console.log(e);var t=e.currentTarget.dataset.file_id;console.log(t),$(e.currentTarget).hasClass("waiting")&&$(e.target).hasClass("btn-icon")&&(s.push(parseInt(t)),h(3,t)),$(e.currentTarget).hasClass("cancel")&&$(e.target).hasClass("btn-icon")})}function h(e,t){var a=i[t],o=uploadHtml(e,a,t);m(o),$(n[t],l).replaceWith(o),n.splice(t,1,o)}function v(e,t,o,i){var l=new FormData;l.append(e.last_name,o);var s="/upload?path="+encodeURI(f(e.tree_path));http({type:"POST",url:s,data:l,onProgress:function(e){console.log(e.percent),console.log($(n[a]),a,"23")},onSuccess:function(a){console.log(a),a.fmd5=t,0==a.status?function(e,t,a){var o={pid:t.id,size:e.file.size,type:3,name:e.file.filename};local_api._get("document",o,"",$.cookie("appkey"),function(o){if(0!=o.status||o.data){if(0==o.status&&o.data){var n={id:o.data.id,tree_path:o.data.tree_path};a(n)}}else{var i=e.file.mimetype.indexOf("image")>-1?"png":"txt",l={size:e.file.size,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:t.id,type:3,filetype:i,name:e.file.filename,path:"/upload/"+f(t.tree_path)+e.file.filename,f_md5:e.fmd5,u_path:r,ispass:1};local_api._create("document",l,$.cookie("appkey"),function(e){var o=t.tree_path+","+e.id,n={id:e.id,tree_path:o};local_api._update("document",{id:e.id},{tree_path:o},$.cookie("appkey"),function(e){a(n)})})}})}(a,e,function(e){i(e)}):i(a)},onError:function(e){i(res)}})}dataControl.getParents(o,c[c.length-1]).reverse().forEach(e=>{e.name+"/"}),Array.prototype.forEach.call(t,function(e,t){console.log(e),$(".mod-tasks").show();var o=uploadHtml(0,e,a+t);m(o),n.push(o),i.push(e),l.append(o)}),function e(){var t=i[a];if(s.indexOf(a)>-1)return a++,void e();if(i.length==a)$(".mod-tasks .tasks-header").removeClass("tasking-nor").addClass("result-succ"),$(".mod-tasks .summary-wrapper .txt").text("任务已完成");else{var o=(a/i.length).toFixed(1);$(".mod-tasks .summary-wrapper .before").css("transform",`scaleX(${o})`),$(".mod-tasks .summary-wrapper .txt").text(`${a}/${i.length}项任务进行中`)}t&&function(e,t,a){get_filemd5sum(e,function(t){var o=e.name;!function(e,t){var a=o.indexOf("【"),n=o.indexOf("】");if(a>-1&&n>0){var i=o.slice(a+1,n),l=o.slice(n+1,o.length),s=i.split("_"),c={did:s[0],name:s[0]+s[1],tree_path:"^"+d,pid:u};local_api._get("document",c,"",$.cookie("appkey"),function(e){if(0==e.status&&e.data)if(s[2]){var a={name:s[2],tree_path:"^"+e.data.tree_path,pid:e.data.id};local_api._get("document",a,"",$.cookie("appkey"),function(a){if(a.data)t(Object.assign(a.data,{last_name:l}));else{var o={name:s[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:e.data.id,u_path:r};local_api._create("document",o,$.cookie("appkey"),function(a){var o=e.data.tree_path+","+a.id,n={id:a.id,tree_path:o,last_name:l};local_api._update("document",{id:a.id},{tree_path:o},$.cookie("appkey"),function(e){t(n)})})}})}else t(Object.assign(e.data,{last_name:l}));else{var o={name:s[0]+s[1],did:s[0],type:2,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:u,u_path:r};local_api._create("document",o,$.cookie("appkey"),function(e){var a=d+","+e.id,o={id:e.id,tree_path:a,last_name:l};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(e){if(s[2]){var a={name:s[2],type:4,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),pid:o.id,u_path:r};local_api._create("document",a,$.cookie("appkey"),function(e){var a=o.tree_path+","+e.id,n={id:e.id,tree_path:a,last_name:l};local_api._update("document",{id:e.id},{tree_path:a},$.cookie("appkey"),function(e){t(n)})})}})})}})}else{t({id:u,tree_path:d,last_name:o})}}(0,function(o){L(function(){var n="",i=o.last_name,l="",s=0;i.lastIndexOf(".")>-1?(n=i.slice(0,i.lastIndexOf(".")),l=i.slice(i.lastIndexOf("."))):(n=i,l="");var c=t;-1!=c&&function t(){s++;var d={name:i,tree_path:"^"+o.tree_path,type:3};local_api._get("document",d,"",$.cookie("appkey"),function(d){0==d.status&&d.data?d.data.f_md5==c?a(d.data):(i=n+"("+s+")"+l,t()):0!=d.status||d.data||(o.last_name=i,v(o,c,e,a))})}()})})})}(t,0,function(t){console.log($(n[a],l),a,"22"),t.id?h(1,a):h(2,a),a++,t.name||F(p),e()})}()}),e.click()}tools.addEvent(ue,"mouseup",function(){if(J=tools.$(".file-item",w),W=tools.$(".checkbox",w),createOperate("重命名"),K().length)if(K().length>1)showTips("err","只能对单个文件重命名！");else{var e=$(".file-checked .file-title"),t=$(".file-checked .item").data().fileId,a=$(".file-checked .item").data().tree_path,o=$(".file-checked .item").data().type;if(console.log($(".file-checked .item").data()),0==$(".file-checked .item").data().type)return void showTips("err","无法对客户文件夹进行重命名!");var n=e.text(),i=`<span class="file-edtor"> <input type="text" value="${n}" class="edtor"></span>`;e.css("display","none"),e.parent().append(i);var l=$(".file-checked .edtor"),s=$(".file-checked .file-edtor")[0];function c(e){if(!e||e.target.parentNode!=s){var i=l.val().trim();if(""==i)showTips("err","请输入文件名！");else{var d,r,u=f(a);3==o?(d=u+n,r=u+i):(d=u,r=u.slice(0,u.lastIndexOf(n))+i),console.log(u);var m={type:1,oldPath:d,newPath:r};local_api._rename(m,$.cookie("appkey"),function(e){console.log(e),0==e.status?local_api._update("document",{id:t},{name:i},$.cookie("appkey"),function(e){0==e.status&&(showTips("ok","重命名成功"),F(p))}):(showTips("err",e.message),F(p))})}tools.removeEvent(document,"mousedown",c)}}l.select(),$(".file-checked .file-edtor").on("mousedown",function(e){e.stopPropagation()}),l.on("keypress",function(e){13==e.keyCode&&c()}),tools.addEvent(document,"mousedown",c)}else showTips("err","请选择文件！")}),tools.addEvent(tools.$(".nav-box")[0],"click",function(e){console.log(tools.getTarget(e)),console.log(tools.getTarget(e).parentNode),tools.hasClass(tools.getTarget(e).parentNode,"nav-list")&&(tools.each(tools.$(".nav-list.nav-current"),function(e){console.log(e.className),tools.removeClass(e,"nav-current")}),tools.addClass(tools.getTarget(e).parentNode,"nav-current")),console.log(tools.hasClass(tools.getTarget(e).parentNode,"nav-list"))}),tools.addEvent(tools.$("#search")[0],"focus",function(){var e=tools.$("#_search_bar")[0];tools.addClass(e,"focus")}),tools.addEvent(tools.$("#search")[0],"blur",function(){var e=tools.$("#_search_bar")[0];setTimeout(()=>{tools.removeClass(e,"focus")},200)}),$("#search").on("keypress",function(e){createOperate("文件检索"),13==e.keyCode&&""!=e.target.value.trim()&&(location.href="/hightSearch?query="+e.target.value.trim())}),$(".upload").on("click",function(e){e.stopPropagation(),me()}),$(".upload-file").on("click",function(e){e.stopPropagation();var t=e.target.parentNode,a=e.target.parentNode.parentNode,o=$(".upload-file").children().children();t!=o[0]&&a!=o[0]||me()}),$(".delete").on("click",function(e){console.log(K());var t=K();if(K().length){var a=[],o=[],n={},i=[],l=[];t.forEach(e=>{var t=$(".item",e).data().type,s={};if(0!=t?(a.push("^"+$(".item",e).data().tree_path),3==t?(s.tree_path="^"+$(".item",e).data().tree_path,s.path=$(".item",e).data().filepath):(s.tree_path="^"+$(".item",e).data().tree_path,s.path=f($(".item",e).data().tree_path)),l.push(s)):o.push("^"+$(".item",e).data().tree_path),!n[t]){n[t]=1;var c=1==t?"分类":2==t?"案卷":3==t?"文件":"";i.push(c)}}),createOperate("文件删除"),console.log(l),o.length>0&&showTips("err","无法对客户文件夹进行删除操作");var s=`确定要删除${t.length>1?"这些":"这个"}${i.join("/")}？`;a.length&&confirm(s)&&l.forEach((e,t)=>{local_api._fsDelete({curPath:e.path},$.cookie("appkey"),function(a){0==a.status&&local_api._delete("document",{tree_path:e.tree_path},$.cookie("appkey"),function(e){t==l.length-1&&(F(p),showTips("ok",`删除${i.join("/")}成功!`))})})})}else showTips("err","请选择文件或档案！")}),$(".logout").on("mousedown",function(e){e.stopPropagation(),location.href="/logout"}),$("#showList").click(function(){$(".mod-tasks").toggleClass("expand")}),$("#hideList").click(function(){$(".mod-tasks").hide(),n=[],i=[],l.empty(),fileIndex=0}),$("#divCombind").dialog({width:400,maxHeight:400,autoOpen:!1,buttons:{"确定":function(){!function(){var e={handle_json:{input:{},output:""},update:{path:"",name:"",size:""},query:{id:""},delete_j:{id:""}},t=[],a=K();if(a.length?a.forEach(e=>{var a=$(".item",e).data();a.name=$(".item .file-title",e).text(),a.size=backFileSize($(".item ul>li:nth-child(1)",e).text()),t.push(a)}):showTips("err","请选择pdf文件进行合并！"),t.length){var o=0,n=[];t.forEach((t,a)=>{o+=t.size,e.handle_json.input[a]=f(t.tree_path)+t.name,0==a?(e.query.id=t.fileId,e.update.name=$("#renameCombind").val().trim()+".pdf",e.update.path="/upload/"+f(t.tree_path)+$("#renameCombind").val().trim()+".pdf",e.handle_json.output=f(t.tree_path)+$("#renameCombind").val().trim()+".pdf"):n.push(t.fileId)}),e.delete_j.id=n.join("|"),e.update.size=o,createOperate("合并文件"),confirm("确定合并已选择的文件")?local_api._fsCombind(e.handle_json,$.cookie("appkey"),function(t){0==t.status?local_api._update("document",e.query,e.update,$.cookie("appkey"),function(t){local_api._delete("document",e.delete_j,$.cookie("appkey"),function(e){showTips("ok","合并成功!"),$("#divCombind").dialog("close"),X(u)})}):(showTips("err","合并失败!"),$("#divCombind").dialog("close"))}):$("#divCombind").dialog("close")}else showTips("err","请选择pdf文件进行合并！")}()},"取消":function(){$("#divCombind").dialog("close")}}}),$("#combind").on("click",function(){$("#divCombind").dialog("open")}),$("#export").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){var t=$(this)[0].files;he(t)}),e.click()}),$("#exportPorp").click(function(){var e=document.createElement("input");e.type="file",$(e).change(function(e){$(this)[0].files}),e.click()});var he=function(e){createOperate("导入台账");var t=new FileReader;t.readAsBinaryString(e[0]),t.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"}).SheetNames,n={},i=o.filter(e=>1==e.type&&e.tree_path.indexOf(d)>-1);for(var l in a.forEach((e,t)=>{i.forEach(t=>{e.trim()==t.name&&(console.log(t),n[e]={tree_path:t.tree_path,id:t.id,createArr:[],createDoc:[]})})}),n);console.log(n)}}}()}});